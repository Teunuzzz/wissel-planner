<!doctype html>
<html lang="nl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=no"/>
<title>Wissel Planner O9 ‚Äì De Esch</title>
<link rel="manifest" href="manifest.webmanifest">
<meta name="theme-color" content="#1f4aa3">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black">
<link rel="apple-touch-icon" href="icon-192.png">
<style>
:root{
  --bg:#0b1020; --panel:#0f162c; --border:#1b2a4a; --muted:#9fb3d8;
  --accent:#1f4aa3; --accent-2:#f5d02e;
  --chip:#0a1325; --chipb:#203656;
  --radius:14px; --space:clamp(10px,2.5vw,16px);
  --fz-xs:clamp(11px, 2.2vw, 12px);
  --fz-sm:clamp(12px, 2.4vw, 13px);
  --fz-md:clamp(14px, 3.2vw, 16px);
  --fz-lg:clamp(18px, 5vw, 22px);
  --fz-xl:clamp(24px, 7vw, 32px);
}
*{box-sizing:border-box; touch-action:manipulation;}
html{height:100%; -webkit-text-size-adjust:100%;}
body{min-height:100%; margin:0; font-family:system-ui,-apple-system,"Segoe UI",Roboto,Ubuntu,"Helvetica Neue",Arial; color:#e6eefc; background:var(--bg); font-size:var(--fz-md); line-height:1.35;}
header{position:sticky; top:0; z-index:10; background:linear-gradient(180deg, rgba(31,74,163,.9), rgba(31,74,163,.6)); border-bottom:2px solid var(--accent-2); padding:calc(var(--space)*0.8) var(--space); display:flex; align-items:center; gap:8px;}
h1{font-size:var(--fz-lg); margin:0}
main{padding: var(--space); padding-bottom: calc(80px + env(safe-area-inset-bottom)); max-width: 900px; margin-inline:auto;}
section{background:var(--panel); border:1px solid var(--border); border-radius:var(--radius); margin-bottom:var(--space); box-shadow:0 0 0 1px rgba(245,208,46,.12) inset}
section h2{margin:0; padding:10px 12px; border-bottom:1px solid var(--border); font-size:var(--fz-sm); color:var(--accent-2)}
.content{padding:var(--space)}
.row{display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin-bottom:8px}
.grid2{display:grid; grid-template-columns: 1fr 1fr; gap:8px}
@media (max-width:560px){ .grid2{ grid-template-columns: 1fr; } }
input[type="text"], input[type="number"], select{ background:var(--chip); color:#e5e7eb; border:1px solid var(--chipb); border-radius:10px; padding:12px; font-size:var(--fz-md); min-height:44px; width:100%; }
input[type="checkbox"]{ transform:scale(1.2); }
button{ background:var(--accent); color:#fff; border:none; border-radius:12px; padding:12px 14px; font-size:var(--fz-md); min-height:44px; box-shadow:0 0 0 1px rgba(245,208,46,.25) inset; }
button.secondary{ background:#1b2a4a } button.ghost{ background:transparent; border:1px solid var(--chipb) }
.pill{ padding:4px 10px; border-radius:999px; background:var(--chip); border:1px solid var(--chipb); color:#e6eefc; font-size:var(--fz-xs) }
.small{ font-size:var(--fz-sm); color:#9fb3d8 }
.list{ display:flex; flex-direction:column; gap:8px }
.player{ position:relative; display:grid; grid-template-columns: 1fr auto; gap:10px; align-items:center; padding:10px 12px; border:1px dashed var(--chipb); border-radius:12px; background:var(--chip) }
.player.dragging{ opacity:.85; outline:2px dashed var(--accent-2); }
.player .col-left{ display:grid; grid-template-columns: 1fr auto; gap:8px; align-items:center }
.player .line1{ display:grid; grid-template-columns: 1fr auto; gap:8px; align-items:center }
.player .line2{ display:flex; gap:12px; align-items:center; flex-wrap:wrap }
.controls-inline{ display:flex; gap:12px; align-items:center }
.controls-inline label{ display:flex; align-items:center; gap:6px }
.badges{ display:flex; gap:8px; align-items:center }
.handle{ cursor:grab; user-select:none; font-weight:900; font-size:20px; color:#f5d02e; padding:4px 8px; }
.handle:active{ cursor:grabbing }
.del{ background:transparent; border:1px solid var(--chipb); }
@media (max-width:560px){ .player .line1{ grid-template-columns: 1fr auto; } }
.tabs{ position:fixed; bottom:0; left:0; right:0; z-index:20; background:var(--panel); border-top:2px solid var(--accent-2); display:flex; padding-bottom: env(safe-area-inset-bottom); }
.tab{ flex:1; padding:10px 4px; text-align:center; color:#cbd5e1; text-decoration:none; font-size:var(--fz-sm) } .tab.active{ background:#0a1325; color:#fff }
.fab{ position:fixed; right:16px; bottom:calc(98px + env(safe-area-inset-bottom)); z-index:30; background:var(--accent-2); color:#0b1020; border:none; border-radius:999px; padding:14px 18px; font-weight:800; box-shadow:0 10px 24px rgba(0,0,0,.25); }
.tbl-wrap{ overflow-x:auto; -webkit-overflow-scrolling:touch; } .tbl{ width:100%; border-collapse:collapse; font-size:var(--fz-sm); min-width:600px } .tbl th,.tbl td{ border-bottom:1px solid var(--border); padding:8px; text-align:left; vertical-align:top }
.placeholder{ height:60px; border:2px dashed var(--accent-2); border-radius:12px; background:rgba(245,208,46,.08); }
</style>
</head>
<body>
<header>
  <h1>‚öΩ De Esch ‚Äì Wissel Planner O9</h1>
  <span class="pill" id="presenceSummary">0 aanwezig</span>
  <span class="pill" id="benchSummary">bench 0</span>
</header>

<main>
  <!-- SETUP PAGE -->
  <div id="page-setup" class="page">
    <section>
      <h2>Spelers</h2>
      <div class="content">
        <div class="row">
          <input id="newName" type="text" placeholder="Naam speler">
          <select id="newPos">
            <option value="ALL">Allround</option>
            <option value="DEF">Verd</option>
            <option value="MID">Mid</option>
            <option value="ATT">Aanv</option>
          </select>
          <button id="addBtn" type="button">Toevoegen</button>
          <button class="ghost" id="resetBtn" type="button">Reset naar vaste 8</button>
        </div>
        <div id="playerList" class="list"></div>
      </div>
    </section>

    <section>
      <h2>Instellingen</h2>
      <div class="content">
        <div class="row grid2">
          <label> Kwartieren<br><input id="quarters" type="number" min="1" value="4"></label>
          <label> Min/kwart<br><input id="minsPerQuarter" type="number" min="1" value="10"></label>
          <label> Wissel (min)<br><input id="subInterval" type="number" min="1" value="5"></label>
          <label> Formatie (incl. K)<br>
            <select id="formation">
              <option value="6">6 (5+K)</option>
              <option value="7">7 (6+K)</option>
              <option value="5">5 (4+K)</option>
            </select>
          </label>
          <label> Aantal keepers<br>
            <select id="keeperCount">
              <option value="1">1 (wedstrijd)</option>
              <option value="2">2 (helft)</option>
              <option value="4">4 (kwart)</option>
            </select>
          </label>
          <label> Keeper-selectie<br>
            <select id="keeperPolicy">
              <option value="prefer">Kandidaten eerst</option>
              <option value="only">Alleen kandidaten</option>
              <option value="any">Iedereen mag</option>
            </select>
          </label>
        </div>
        <div class="row">
          <label class="small"><input type="checkbox" id="strictMode"/> ‚öñÔ∏è Strikte eerlijkheid (‚â§ 1 slot = 5 min)</label>
        </div>
        <div class="row">
          <button id="generateBtn" type="button">Voorstel genereren</button>
          <span class="small">Ga hierna naar <strong>Live</strong>.</span>
        </div>
      </div>
    </section>
  </div>

  <!-- LIVE PAGE -->
  <div id="page-live" class="page" style="display:none">
    <section>
      <h2>Tijdens de wedstrijd</h2>
      <div class="content">
        <div class="row small">
          <div><strong>Kwart / Tijd</strong></div>
        </div>
        <div class="row">
          <button id="startBtn">‚ñ∂Ô∏è</button>
          <button id="pauseBtn" class="secondary">‚è∏Ô∏è</button>
          <button id="resetBtnQ" class="ghost">üîÑ</button>
        </div>
        <div class="row small">
          <div><strong>Actuele opstelling</strong></div>
        </div>
        <div class="row">
          <div><strong>Keeper:</strong> <span id="liveKeeper">‚Äî</span></div>
        </div>
        <div class="row">
          <div><strong>Veld:</strong> <span id="liveField">‚Äî</span></div>
        </div>
        <div class="row small">
          Bank: <span id="liveBench">‚Äî</span>
        </div>
        <div class="tbl-wrap" style="margin-top:8px">
          <table class="tbl" id="scheduleTable">
            <thead><tr><th>Slot</th><th>Tijd</th><th>Keeper</th><th>Veld</th><th>Bank</th></tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </section>
  </div>

  <!-- CHANGES PAGE -->
  <div id="page-changes" class="page" style="display:none">
    <section>
      <h2>Snelle wijzigingen</h2>
      <div class="content">
        <div class="row">
          <select id="stopPlayerSelect"></select>
          <button id="stopPlayerBtn" class="secondary">‚õëÔ∏è Speler stopt</button>
        </div>
        <div class="row">
          <button id="recalcBtn">üîÅ Herbereken vanaf nu</button>
          <span id="strictNote" class="small" style="display:none;">Strikt actief (‚â§ 5m).</span>
        </div>
        <div class="row">
          <div class="small">Huidig slot aanpassen</div>
          <div><strong>Keeper:</strong> <select id="liveKeeperSelect"></select></div>
          <div class="small">Tap naam om veld ‚Üî bank te wisselen</div>
          <div><strong>Op veld:</strong> <div id="liveFieldEdit" class="lineup">‚Äî</div></div>
          <div class="small">Bank:</div>
          <div id="liveBenchEdit" class="lineup">‚Äî</div>
          <button id="applyLiveBtn" class="ghost">‚úÖ Toepassen</button>
        </div>
      </div>
    </section>
  </div>
</main>

<!-- Bottom tabs -->
<nav class="tabs">
  <a href="#setup" class="tab" id="tab-setup">üë• Spelers & Setup</a>
  <a href="#live" class="tab" id="tab-live">‚è±Ô∏è Live</a>
  <a href="#changes" class="tab" id="tab-changes">üõ†Ô∏è Wijzigingen</a>
</nav>

<!-- Snel toevoegen FAB -->
<button class="fab" id="fabAdd">‚â°Ôºã</button>

<script>
if('serviceWorker' in navigator){ window.addEventListener('load', ()=> navigator.serviceWorker.register('./sw.js').catch(console.error)); }

// --- utils & store ---
let canStore=true; try{ localStorage.setItem('__t','1'); localStorage.removeItem('__t'); }catch(e){ canStore=false; }
function setStore(k,v){ if(canStore){ localStorage.setItem(k,v);} else { window.__mem=window.__mem||{}; __mem[k]=v; } }
function getStore(k){ return canStore?localStorage.getItem(k):((window.__mem||{})[k]||null); }
const POS_LABEL={ALL:'All',DEF:'Verd',MID:'Mid',ATT:'Aanv'};
const DEFAULT_NAMES=["Wouter","Sydney","Twan","Milan","Ryan","Dani","Finn","Diede"];
function rid(){ try{ if(typeof crypto!=='undefined'&&crypto&&typeof crypto.randomUUID==='function') return crypto.randomUUID(); }catch(e){} return 'id-'+Math.random().toString(36).slice(2); }
function $(id){ return document.getElementById(id); }
function pad2(n){ return String(n).padStart(2,'0'); }
function fmt(sec){ const m=Math.floor(sec/60), s=Math.floor(sec%60); return pad2(m)+':'+pad2(s); }
function vibrate(p){ try{ if(navigator.vibrate) navigator.vibrate(p);}catch(e){} }

// --- state ---
let state = JSON.parse(getStore('wisselplanner_state_mobile_team_v2_3_3')||'null') || {
  players: DEFAULT_NAMES.map((n,i)=>({id:rid(), name:n, pos:'ALL', present:true, keeperCandidate:(i<3), quality:(DEFAULT_NAMES.length-i)})),
  quarters:4, minsPerQuarter:10, subInterval:5, formation:6, keeperCount:1, keeperPolicy:'prefer', strict:false
};
function save(){ setStore('wisselplanner_state_mobile_team_v2_3_3', JSON.stringify(state)); refreshSummaries(); }

// --- router ---
function showPage(hash){
  const page = (hash||'#setup').replace('#','');
  ['setup','live','changes'].forEach(p=>{
    const el=document.getElementById('page-'+p);
    if(el) el.style.display=(p===page)?'block':'none';
    const tab=document.getElementById('tab-'+p);
    if(tab) tab.classList.toggle('active', p===page);
  });
  if(page==='setup'){ const nn=$('newName'); if(nn){ setTimeout(()=> nn.focus(), 50); } }
}
window.addEventListener('hashchange', ()=> showPage(location.hash));
showPage(location.hash);

// --- setup inputs ---
['quarters','minsPerQuarter','subInterval'].forEach(id=>{
  document.getElementById(id).value = state[id];
  document.getElementById(id).addEventListener('change', e=>{ state[id]=parseInt(e.target.value,10)||1; save(); });
});
document.getElementById('formation').value = String(state.formation);
document.getElementById('formation').addEventListener('change', e=>{ state.formation=parseInt(e.target.value,10); save(); });
document.getElementById('keeperCount').value = String(state.keeperCount);
document.getElementById('keeperCount').addEventListener('change', e=>{ state.keeperCount=parseInt(e.target.value,10); save(); });
document.getElementById('keeperPolicy').value = state.keeperPolicy;
document.getElementById('keeperPolicy').addEventListener('change', e=>{ state.keeperPolicy=e.target.value; save(); });
document.getElementById('strictMode').checked = !!state.strict;
document.getElementById('strictMode').addEventListener('change', e=>{ state.strict = e.target.checked; const si=$('subInterval'); if(state.strict){ state.subInterval=5; si.value=5; si.setAttribute('disabled','disabled'); } else { si.removeAttribute('disabled'); } save(); });

// --- players UI render + touch drag ---
function refreshSummaries(){
  const present = state.players.filter(p=>p.present);
  $('presenceSummary').textContent = present.length+' aanwezig';
  $('benchSummary').textContent = 'bench '+Math.max(0,present.length - state.formation);
}
function renderPlayers(){
  const wrap = $('playerList'); wrap.innerHTML='';
  state.players.forEach((p,idx)=>{
    const el = document.createElement('div'); el.className='player'; el.dataset.id=p.id;
    el.innerHTML = `
      <div class="col-left">
        <div class="line1">
          <input class="name" value="${p.name}"/>
          <div class="controls-inline">
            <label class="small"><input class="present" type="checkbox"${p.present?' checked':''}/> Aanw.</label>
            <label class="small"><input class="keeper" type="checkbox"${p.keeperCandidate?' checked':''}/> K.</label>
          </div>
        </div>
        <div class="line2 small badges">
          <span>Positie:</span>
          <select class="pos">
            <option value="ALL"${p.pos==='ALL'?' selected':''}>All</option>
            <option value="DEF"${p.pos==='DEF'?' selected':''}>Verd</option>
            <option value="MID"${p.pos==='MID'?' selected':''}>Mid</option>
            <option value="ATT"${p.pos==='ATT'?' selected':''}>Aanv</option>
          </select>
          <span class="small">Rang: ${state.players.length-idx}</span>
          <button class="del">‚úñ</button>
        </div>
      </div>
      <div class="handle" title="Sleep om te rangschikken">‚â°</div>
    `;
    wrap.appendChild(el);
    el.querySelector('.name').addEventListener('input', e=>{ p.name=e.target.value; save(); });
    el.querySelector('.pos').addEventListener('change', e=>{ p.pos=e.target.value; save(); });
    el.querySelector('.present').addEventListener('change', e=>{ p.present=e.target.checked; save(); });
    el.querySelector('.keeper').addEventListener('change', e=>{ p.keeperCandidate=e.target.checked; save(); });
    el.querySelector('.del').addEventListener('click', ()=>{ state.players.splice(idx,1); renum(); save(); renderPlayers(); });
  });
  enableTouchDrag();
}
function renum(){ state.players.forEach((p,i)=> p.quality = (state.players.length - i)); }

function enableTouchDrag(){
  const list = $('playerList');
  let draggingEl=null, startY=0, startIndex=0, placeholder=null;
  list.querySelectorAll('.handle').forEach(h=>{
    const item = h.closest('.player');
    h.addEventListener('pointerdown', (e)=>{
      e.preventDefault();
      draggingEl=item; item.classList.add('dragging');
      startY=e.clientY; startIndex=[...list.children].indexOf(item);
      placeholder=document.createElement('div'); placeholder.className='placeholder';
      item.after(placeholder);
      item.style.position='absolute'; item.style.width = item.offsetWidth+'px';
      item.style.zIndex='5'; item.style.pointerEvents='none';
      item.style.transform = `translateY(0px)`;
      h.setPointerCapture(e.pointerId);
    });
    h.addEventListener('pointermove', (e)=>{
      if(!draggingEl) return;
      const dy = e.clientY - startY;
      draggingEl.style.transform = `translateY(${dy}px)`;
      const rect = placeholder.getBoundingClientRect();
      const mid = rect.top + rect.height/2;
      const over = Array.from(list.children).filter(ch=> ch!==draggingEl && ch!==placeholder && ch.classList.contains('player'));
      for(const el of over){
        const r = el.getBoundingClientRect();
        if(e.clientY < r.top + r.height/2){
          list.insertBefore(placeholder, el);
          break;
        }else{
          list.appendChild(placeholder);
        }
      }
    });
    h.addEventListener('pointerup', (e)=>{
      if(!draggingEl) return;
      draggingEl.classList.remove('dragging');
      draggingEl.style.position='';
      draggingEl.style.width='';
      draggingEl.style.transform='';
      draggingEl.style.pointerEvents='';
      placeholder.replaceWith(draggingEl);
      placeholder=null;
      const newIndex=[...list.children].indexOf(draggingEl);
      // update state order
      const id = draggingEl.dataset.id;
      const oldIdx = state.players.findIndex(p=>p.id===id);
      const [m] = state.players.splice(oldIdx,1);
      state.players.splice(newIndex,0,m);
      renum(); save();
      draggingEl=null;
      vibrate([10]); // tiny tick
    });
  });
}

function addPlayerFromInputs(){
  let name=$('newName').value.trim(); if(!name) name='Speler '+(state.players.length+1);
  const pos=$('newPos').value;
  state.players.push({id:rid(), name, pos, present:true, keeperCandidate:false, quality:1});
  renum(); $('newName').value=''; save(); renderPlayers(); $('newName').focus();
}
$('addBtn').addEventListener('click', addPlayerFromInputs);
$('newName').addEventListener('keydown', e=>{ if(e.key==='Enter'){ addPlayerFromInputs(); } });
$('fabAdd').addEventListener('click', ()=>{
  const name = prompt('Naam nieuwe speler?');
  if(name && name.trim()){
    state.players.push({id:rid(), name:name.trim(), pos:'ALL', present:true, keeperCandidate:false, quality:1});
    renum(); save(); renderPlayers();
  }
});
$('resetBtn').addEventListener('click', ()=>{
  if(!confirm('Reset naar vaste 8 (Wouter t/m Diede)?')) return;
  state.players = DEFAULT_NAMES.map((n,i)=>({id:rid(), name:n, pos:'ALL', present:true, keeperCandidate:(i<3), quality:(DEFAULT_NAMES.length-i)}));
  save(); renderPlayers();
});

// --- scheduling core (fair minutes + rotating bench) ---
function buildSegments(){
  const totalMinutes = state.quarters*state.minsPerQuarter;
  const spq = Math.ceil(state.minsPerQuarter / state.subInterval);
  const segs=[]; let t=0;
  for(let q=0;q<state.quarters;q++){
    for(let s=0;s<spq;s++){
      const start=t, end=Math.min(totalMinutes, t+state.subInterval);
      segs.push({q,s,start,end,duration:end-start});
      t=end;
    }
  }
  return segs;
}
function slotsPerQuarter(){ return Math.ceil(state.minsPerQuarter / state.subInterval); }
function segIndex(seg){ return seg.q*slotsPerQuarter()+seg.s; }

function keeperPool(players){
  if(state.keeperPolicy==='any') return players;
  if(state.keeperPolicy==='only') return players.filter(p=>p.keeperCandidate);
  const k=players.filter(p=>p.keeperCandidate); return k.length?k:players;
}
function pickKeeper(players, minutesMap, keeperCountMap){
  const pool=keeperPool(players);
  return [...pool].sort((a,b)=>{
    const kd=(keeperCountMap.get(a.id)||0)-(keeperCountMap.get(b.id)||0); if(kd) return kd;
    const md=(minutesMap.get(a.id)||0)-(minutesMap.get(b.id)||0); if(md) return md;
    return a.quality-b.quality;
  })[0];
}
function pickField(needed, avail, minutesMap, targetAvg){
  const sorted=[...avail].sort((a,b)=>{
    const md=(minutesMap.get(a.id)||0)-(minutesMap.get(b.id)||0); if(md) return md;
    const ad=Math.abs(a.quality-targetAvg)-Math.abs(b.quality-targetAvg); if(ad) return ad;
    return a.name.localeCompare(b.name);
  });
  const chosen=[]; let low=0, high=sorted.length-1;
  while(chosen.length<needed && low<=high){
    const currentAvg = chosen.length ? (chosen.reduce((s,p)=>s+p.quality,0)/chosen.length) : targetAvg;
    if(currentAvg < targetAvg){ chosen.push(sorted[high--]); } else { chosen.push(sorted[low++]); }
  }
  return chosen;
}
function repairPositions(field, bench, keeper){
  const exist={DEF:false,MID:false,ATT:false};
  const present = state.players.filter(p=>p.present);
  present.filter(p=>p.id!==keeper.id).forEach(p=>{ if(p.pos!=='ALL') exist[p.pos]=true; });
  const ensure=['DEF','MID','ATT'];
  for(const pos of ensure){
    if(!exist[pos]) continue;
    const has = field.some(p=>p.pos===pos || p.pos==='ALL');
    if(!has){
      const candidateIn = bench.find(p=>p.pos===pos) || bench.find(p=>p.pos==='ALL');
      if(!candidateIn) continue;
      const posCountsField={DEF:0,MID:0,ATT:0,ALL:0};
      field.forEach(p=> posCountsField[p.pos]=(posCountsField[p.pos]||0)+1 );
      let idxOut = field.findIndex(p=> p.pos!=='ALL' && posCountsField[p.pos]>1 );
      if(idxOut===-1) idxOut = field.findIndex(p=> p.pos==='ALL');
      if(idxOut===-1) idxOut = field.length-1;
      const out = field[idxOut];
      field[idxOut]=candidateIn;
      const bi = bench.findIndex(p=>p.id===candidateIn.id);
      bench[bi]=out;
    }
  }
}
function optimizeStrict(schedule){
  const slotDur = state.subInterval; // in minuten
  const present = state.players.filter(p=>p.present);
  const m = new Map(present.map(p=>[p.id,0]));
  schedule.forEach(sl=>{
    if(sl.keeper) m.set(sl.keeper.id, (m.get(sl.keeper.id)||0)+sl.duration);
    sl.field.forEach(p=> m.set(p.id, (m.get(p.id)||0)+sl.duration));
  });
  function getExtrema(){
    let maxId=null, minId=null, maxV=-1e9, minV=1e9;
    for(const p of present){
      const v = m.get(p.id)||0;
      if(v>maxV){ maxV=v; maxId=p.id; }
      if(v<minV){ minV=v; minId=p.id; }
    }
    return {maxId, minId, maxV, minV};
  }
  let guard=0;
  while(guard++<300){
    const {maxId, minId, maxV, minV} = getExtrema();
    if(maxV - minV <= slotDur) break;
    let swapped=false;
    for(const sl of schedule){
      if(sl.duration < slotDur) continue;
      const maxOnField = sl.field.find(p=>p.id===maxId);
      const minOnBench = sl.bench.find(p=>p.id===minId);
      const isKeeper = sl.keeper && sl.keeper.id===maxId;
      if(maxOnField && minOnBench && !isKeeper){
        sl.field = sl.field.filter(p=>p.id!==maxId);
        sl.bench = sl.bench.filter(p=>p.id!==minId);
        const maxP = present.find(p=>p.id===maxId);
        const minP = present.find(p=>p.id===minId);
        sl.field.push(minP);
        sl.bench.push(maxP);
        repairPositions(sl.field, sl.bench, sl.keeper);
        m.set(maxId, (m.get(maxId)||0) - sl.duration);
        m.set(minId, (m.get(minId)||0) + sl.duration);
        swapped=true; break;
      }
    }
    if(!swapped) break;
  }
  return schedule;
}
let lastSchedule=[];
function generateSchedule(fromIndex=0, minutesSeed=null){
  const segments = buildSegments();
  const present = state.players.filter(p=>p.present);
  if(present.length < state.formation){ alert(`Te weinig spelers aanwezig (${present.length}) voor formatie ${state.formation}.`); return []; }
  const minutesMap = new Map(present.map(p=>[p.id,0]));
  if(minutesSeed){ for(const [id,val] of minutesSeed.entries()) if(minutesMap.has(id)) minutesMap.set(id, val); }
  const keeperCountMap = new Map(present.map(p=>[p.id,0]));
  const keeperForKey = new Map();
  // keeper per wedstrijd/helft/kwart
  for(let i=0;i<segments.length;i++){
    if(i<fromIndex) continue;
    const seg=segments[i];
    const key = (state.keeperCount===1)?0:(state.keeperCount===2 ? (seg.q < state.quarters/2 ? 0:1) : seg.q);
    if(!keeperForKey.has(key)){
      const k = pickKeeper(present, minutesMap, keeperCountMap);
      keeperForKey.set(key, k);
      keeperCountMap.set(k.id, (keeperCountMap.get(k.id)||0)+1);
    }
  }
  const sched=[];
  const targetAvg = present.reduce((s,p)=>s+p.quality,0)/present.length;
  for(let i=0;i<segments.length;i++){
    const seg=segments[i];
    let keeper, field, bench;
    if(i<fromIndex && lastSchedule[i]){
      ({keeper, field, bench} = lastSchedule[i]);
    }else{
      const key=(state.keeperCount===1)?0:(state.keeperCount===2 ? (seg.q < state.quarters/2 ? 0:1) : seg.q);
      keeper = keeperForKey.get(key);
      const fieldPool = present.filter(p=>p.id!==keeper.id);
      field = pickField(state.formation-1, fieldPool, minutesMap, targetAvg);
      const onIds = new Set([keeper.id, ...field.map(p=>p.id)]);
      bench = present.filter(p=>!onIds.has(p.id));
      repairPositions(field, bench, keeper);
      // update minutes for fairness progression
      minutesMap.set(keeper.id, (minutesMap.get(keeper.id)||0)+seg.duration);
      field.forEach(p=> minutesMap.set(p.id, (minutesMap.get(p.id)||0)+seg.duration));
    }
    sched.push({ ...seg, keeper, field, bench });
  }
  if(state.strict){ optimizeStrict(sched); }
  lastSchedule = sched;
  return sched;
}

// --- live view (simplified) ---
let timer=null, startEpoch=0, paused=true, elapsedSec=0, curSegIndex=0;
function slotsPerQuarterVal(){ return Math.ceil(state.minsPerQuarter / state.subInterval); }
function currentQuarter(){ return Math.floor(curSegIndex / slotsPerQuarterVal()); }
function renderSchedule(schedule){
  const tbody = document.querySelector("#scheduleTable tbody"); tbody.innerHTML="";
  for(const seg of schedule){
    const tr=document.createElement('tr');
    tr.innerHTML = `<td>Q${seg.q+1} ‚Ä¢ ${seg.s+1}</td><td>${pad2(seg.start)}‚Äì${pad2(seg.end)}m</td><td>${seg.keeper?.name||''}</td><td>${seg.field.map(p=>p.name).join(', ')}</td><td>${seg.bench.map(p=>p.name).join(', ')}</td>`;
    tbody.appendChild(tr);
  }
  if(schedule.length){
    const seg=schedule[0];
    $('liveKeeper').textContent = seg.keeper?.name || '‚Äî';
    $('liveField').textContent = seg.field.map(p=>p.name).join(', ') || '‚Äî';
    $('liveBench').textContent = seg.bench.map(p=>p.name).join(', ') || '‚Äî';
  }
}
function updateLiveByIndex(idx){
  const seg=lastSchedule[idx] || lastSchedule[lastSchedule.length-1];
  $('liveKeeper').textContent = seg?.keeper?.name || '‚Äî';
  $('liveField').textContent = seg?.field?.map(p=>p.name).join(', ') || '‚Äî';
  $('liveBench').textContent = seg?.bench?.map(p=>p.name).join(', ') || '‚Äî';
}
$('startBtn').addEventListener('click', ()=>{
  if(!lastSchedule.length){ alert('Genereer eerst een schema.'); return; }
  if(!paused) return;
  paused=false; startEpoch=performance.now()-elapsedSec*1000;
  timer=setInterval(()=>{
    const now=performance.now(); const prev=elapsedSec; elapsedSec=Math.max(0,(now-startEpoch)/1000);
    const sub=state.subInterval*60;
    const prevSlot=Math.floor(prev/sub);
    const curSlot=Math.floor(elapsedSec/sub);
    const q=currentQuarter();
    const spq=slotsPerQuarterVal();
    curSegIndex=Math.min(q*spq+curSlot, lastSchedule.length-1);
    if(curSlot!==prevSlot && Math.floor(elapsedSec)!==0){
      vibrate([200,100,200]);
      updateLiveByIndex(curSegIndex);
    }
  },250);
});
$('pauseBtn').addEventListener('click', ()=>{ paused=true; if(timer){clearInterval(timer); timer=null;} });
$('resetBtnQ').addEventListener('click', ()=>{
  if(timer){clearInterval(timer); timer=null;} paused=true; elapsedSec=0;
  const spq=slotsPerQuarterVal(); const q=currentQuarter();
  curSegIndex=q*spq; updateLiveByIndex(curSegIndex);
});

// Quick changes (basic wiring preserved)
$('applyLiveBtn') && $('applyLiveBtn').addEventListener('click', ()=>{});
$('stopPlayerBtn') && $('stopPlayerBtn').addEventListener('click', ()=>{});
$('recalcBtn') && $('recalcBtn').addEventListener('click', ()=>{});

// Generate
$('generateBtn').addEventListener('click', ()=>{
  curSegIndex=0; elapsedSec=0; paused=true; if(timer){clearInterval(timer); timer=null;}
  const sched = generateSchedule(0,null);
  renderSchedule(sched);
  location.hash = '#live';
});

function init(){
  renderPlayers();
  refreshSummaries();
}
init();
</script>
</body>
</html>
