<!doctype html>
<html lang="nl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>Wisselplanner ‚Äì De Esch</title>
<meta name="theme-color" content="#0a1324">
<link rel="apple-touch-icon" href="icon-512.png">
<link rel="manifest" href="manifest.webmanifest">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Wisselplanner">

<style>
:root{
  --bg:#0a1324;             /* donkerblauw achtergrond */
  --panel:#10203f;          /* iets lichter paneel */
  --border:#1e2b4a;
  --text:#f8fafc;
  --muted:#9ca3af;
  --accent:#f6c500;         /* geel accent */
  --accent-dark:#b79400;    /* donkerder geel voor hover */
  --danger:#ef4444;
  --ok:#16a34a;
}

*{box-sizing:border-box;margin:0;padding:0}
body{
  background:var(--bg);
  color:var(--text);
  font:16px/1.4 "Segoe UI",system-ui,Roboto,Arial;
}
.container{max-width:900px;margin:0 auto;padding:12px}

/* Tabs */
.tabs{display:flex;gap:6px;position:sticky;top:0;background:var(--bg);padding:8px 0;z-index:10}
.tab{flex:1}
.tab button{
  width:100%;padding:12px;border-radius:12px;
  border:1px solid var(--border);
  background:var(--panel);color:var(--text);
  font-weight:700;cursor:pointer;transition:background .2s,border .2s;
}
.tab button.active{background:var(--accent);color:#000;border-color:transparent}
.tab button:hover{background:var(--accent-dark);color:#000}

/* Panels, knoppen enz. */
.card{background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:12px;margin:8px 0}
.row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.btn{padding:12px 14px;border-radius:12px;border:none;background:var(--accent);color:#000;font-weight:700;cursor:pointer;transition:background .2s}
.btn:hover{background:var(--accent-dark)}
.btn.secondary{background:#1e2b4a;color:#fff}
.btn.danger{background:var(--danger);color:#fff}
.btn.small{padding:8px 10px;font-size:.9em}
.pill{padding:8px 10px;border-radius:999px;border:1px solid var(--border);background:#08172e}
input,select{width:100%;padding:12px;border-radius:12px;border:1px solid var(--border);background:#08172e;color:var(--text)}
.grid2{display:grid;grid-template-columns:1fr;gap:8px}@media(min-width:560px){.grid2{grid-template-columns:1fr 1fr}}
.list{display:flex;flex-direction:column;gap:8px}

/* Spelers */
.player{display:flex;align-items:center;gap:8px;padding:10px;border:1px solid var(--border);border-radius:12px;background:#08172e;touch-action:none;-webkit-user-select:none;user-select:none}
.player.dragging{opacity:.6}
.player .drag{cursor:grab;-webkit-touch-callout:none;-webkit-user-drag:none}
.placeholder{border:2px dashed var(--accent);border-radius:12px;height:48px}
.hidden{display:none}

/* Tabellen */
.table{width:100%;border-collapse:collapse}
.table th,.table td{padding:10px;border-top:1px solid var(--border);text-align:left;vertical-align:top}
.table th{color:var(--accent);text-transform:uppercase;font-size:.85em;letter-spacing:.05em}

/* Timer en voortgang */
.timer{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
.big{font-size:44px;font-weight:800}
.match-progress{height:12px;border-radius:999px;background:#08172e;border:1px solid var(--border);overflow:hidden;position:relative}
.match-progress::after{
  content:"";
  position:absolute;inset:0;
  background:
    linear-gradient(to right,transparent 24.5%,var(--border) 24.5%,var(--border) 25.5%,transparent 25.5%),
    linear-gradient(to right,transparent 49.5%,var(--border) 49.5%,var(--border) 50.5%,transparent 50.5%),
    linear-gradient(to right,transparent 74.5%,var(--border) 74.5%,var(--border) 75.5%,transparent 75.5%);
  pointer-events:none;
}
.match-progress .fill{position:absolute;left:0;top:0;height:100%;background:var(--accent);width:0%}
.match-progress .q-marker{position:absolute;top:-3px;width:2px;height:20px;background:var(--accent);border-radius:2px;left:0%;box-shadow:0 0 4px rgba(0,0,0,.4)}

/* Overlay */
.overlay{position:fixed;inset:0;background:rgba(0,0,0,.92);display:none;align-items:center;justify-content:center;z-index:50;padding:16px}
.overlay .panel{max-width:560px;width:100%;background:var(--panel);border:1px solid var(--border);border-radius:16px;padding:16px;text-align:center}
.swaplist{display:flex;gap:12px;justify-content:center;flex-wrap:wrap;margin:10px 0}
.swaplist .col{flex:1 1 220px;background:#08172e;border:1px solid var(--border);border-radius:12px;padding:12px}
.namechip{padding:10px;border:1px solid var(--border);border-radius:10px;margin:6px 0;background:#08172e}
.bar{height:8px;border-radius:8px;background:#08172e;border:1px solid var(--border);overflow:hidden}
.bar>div{height:100%;background:var(--accent);width:0%}

/* Kolommen Snelle wijzigingen */
.col-field{background:rgba(246,197,0,.1);border:1px solid var(--accent)}
.col-bench{background:rgba(10,19,36,.8);border:1px solid var(--border)}

/* Snelle wijz. ‚Äì twee kolommen */
.quick-cols{display:grid;grid-template-columns:1fr;gap:12px}
@media(min-width:560px){.quick-cols{grid-template-columns:1fr 1fr}}
.quick-col{border:1px solid var(--border);border-radius:12px;padding:12px;background:#08172e}
.quick-col h4{margin:0 0 8px;color:var(--accent)}
.chips{display:flex;flex-direction:column;gap:8px}
.chip{display:flex;align-items:center;justify-content:space-between;gap:8px;padding:10px;border:1px solid var(--border);border-radius:10px;background:#0b162d}
.chip .who{font-weight:700}
.chip .act{display:flex;gap:6px}
.chip .btn-move{padding:8px 10px;border:none;border-radius:10px;cursor:pointer;font-weight:700}
.btn-to-bench{background:var(--accent);color:#000}
.btn-to-field{background:#1e2b4a;color:#fff}
.staged{outline:2px solid var(--accent)}
.note{color:var(--muted);font-size:.9em}
  
</style>
</head>

<body>
<div class="container">
  <h1>Wisselplanner <small style="color:var(--accent)">De Esch</small></h1>

<!-- Navigatietabs -->
<div class="tabs">
  <div class="tab"><button class="active" data-tab="setup">Setup & Spelers</button></div>
  <div class="tab"><button data-tab="live">Live</button></div>
  <div class="tab"><button data-tab="quick">Snelle wijzigingen</button></div>
  <div class="tab"><button data-tab="dist">Verdeling</button></div>
</div>

<!-- Globale wedstrijd-progress (zichtbaar op alle tabbladen) -->
<div class="card" id="globalProgress" style="margin-top:10px">
  <div class="row" style="justify-content:space-between;align-items:center;margin-bottom:6px">
    <div class="pill" id="lblQuarter">Kwart 1 / 4</div>
    <div class="big" id="clock" style="font-size:28px;line-height:1">10:00</div>
  </div>
  <div class="match-progress" id="matchProgress">
    <div class="fill" id="matchFill"></div>
    <div class="q-marker" id="quarterMarker"></div>
  </div>
</div>


  <!-- TAB: Setup -->
  <section id="tab-setup" class="card">
    <h2>Team & Spelers</h2>
    <div class="grid2 card">
      <div><label>Teamnaam</label><input id="teamName" placeholder="Teamnaam" value="De Esch O9"></div>
      <div><label>Formatie (aantal veldspelers)</label>
        <select id="formation">
          <option value="4">4</option><option value="5" selected>5</option><option value="6">6</option>
        </select>
      </div>
      <div><label>Keepers per wedstrijd</label>
        <select id="keepersMode">
          <option value="1">1 keeper (hele wedstrijd)</option>
          <option value="2">2 keepers (helften)</option>
          <option value="4" selected>4 keepers (kwarten)</option>
        </select>
      </div>
      <div id="keeperAssignBox"><label>Keeper-keuze (volgens modus)</label><div class="row" id="keeperAssignRow"></div></div>
    </div>

    <div class="card">
      <div class="row" style="justify-content:space-between">
        <h3 style="margin:0">Spelers (sleep om te rangschikken)</h3>
        <div class="row">
          <button class="btn small" id="btnAdd">+ Speler</button>
          <button class="btn small danger" id="btnReset">Reset team</button>
        </div>
      </div>
      <div id="playerList" class="list"></div>
    </div>
    <div class="row"><button class="btn" id="btnSaveSetup">Opslaan & naar Live</button></div>
  </section>

  <!-- TAB: Live -->
  <section id="tab-live" class="card hidden">
    <h2>Live wedstrijd</h2>
    <div class="row" style="gap:8px;flex-wrap:wrap">
  <button class="btn" id="btnStart">‚ñ∂ Start</button>
  <button class="btn secondary" id="btnPause">‚è∏ Pauze</button>
</div>
    <div class="card" id="liveSwapCard">
      <h3>Wissel bij 05:00</h3>
      <div class="row" style="gap:12px;flex-wrap:wrap">
        <div class="pill"><strong>UIT:</strong> <span id="liveSwapOut">‚Äî</span></div>
        <div class="pill"><strong>IN:</strong> <span id="liveSwapIn">‚Äî</span></div>
      </div>
    </div>

    <div class="card">
      <div class="row">
        <div class="pill"><strong>Keeper:</strong> <span id="liveKeeper">‚Äî</span></div>
        <div class="pill"><strong>Veld:</strong> <span id="liveField">‚Äî</span></div>
        <div class="pill"><strong>Bank:</strong> <span id="liveBench">‚Äî</span></div>
      </div>
    </div>

    <table class="table" id="scheduleTable">
      <thead><tr><th>Kwart‚Ä¢Slot</th><th>Tijd</th><th>Veld</th><th>Bank</th></tr></thead>
      <tbody></tbody>
    </table>
  </section>

  <!-- TAB: Snelle wijzigingen -->
  <section id="tab-quick" class="card hidden">
    <h2>Snelle wijzigingen</h2>

    <div class="grid2 card">
      <div><label>Actieve spelers</label><div id="quickActive" class="list"></div></div>
      <div><label>Formatie aanpassen</label><select id="quickFormation"></select></div>
    </div>

    <div><label>Keeper wijzigen (volgens modus)</label><div id="quickKeeperAssign" class="row"></div></div>

<div class="card" id="quickManualSwap">
  <h3 style="margin:0 0 8px">Huidig kwart ‚Äì wissel aanpassen</h3>

  <div class="quick-cols" id="quickSwapCols">
    <div class="quick-col">
      <h4>Veld</h4>
      <div class="chips" id="quickFieldChips"></div>
      <div class="note">Klik op <b>‚Üí bank</b> bij degene die je <u>van het veld</u> wilt halen.</div>
    </div>
    <div class="quick-col">
      <h4>Bank</h4>
      <div class="chips" id="quickBenchChips"></div>
      <div class="note">Klik op <b>‚Üí veld</b> bij degene die je <u>in wil brengen</u>.</div>
    </div>
  </div>

  <div class="row" style="margin-top:10px">
    <button class="btn" id="btnApplyManualSwap">Pas wissel aan</button>
  </div>
  <small class="muted">Na bevestigen wordt de <b>hele wedstrijd</b> opnieuw gepland met zo gelijk mogelijke speelminuten.</small>
</div>

  </section>

  <!-- TAB: Verdeling -->
  <section id="tab-dist" class="card hidden">
    <h2>Verdeling</h2>
    <div class="card">
      <h3>Geplande wissels (alle kwarten)</h3>
      <table class="table" id="distSwaps"><thead><tr><th>Kwart‚Ä¢Slot</th><th>Tijd</th><th>Keeper</th><th>Veld</th><th>Bank</th></tr></thead><tbody></tbody></table>
    </div>
    <div class="card">
      <h3>Speelminuten per speler</h3>
      <table class="table" id="distMinutes"><thead><tr><th>Speler</th><th>Minuten</th><th>Relatief</th></tr></thead><tbody></tbody></table>
    </div>
  </section>
</div>

<!-- Overlay -->
<div class="overlay" id="swapOverlay">
  <div class="panel">
    <h2>Wisselmoment</h2>
    <div class="swaplist">
      <div class="col"><h3>Uit</h3><div id="swapOut"></div></div>
      <div class="col"><h3>In</h3><div id="swapIn"></div></div>
    </div>
    <button class="btn" id="btnDidSwap">Gewisseld</button>
  </div>
</div>
<!-- SCRIPT -->
<script>
/* =========================================================
   Wisselplanner ‚Äì De Esch (v16)
   - Fix: geen nested <script>, geen syntax errors
   - Fix: helperfuncties aanwezig (rebuildScheduleFromQuarter)
   - Fix: snelle wissel werkt; selectie blijft staan
   - UX: klikken op chip selecteert ook (niet alleen knopje)
   - Init: default spelers staan er direct
========================================================= */

const storeKey = 'wisselplanner.v16';   // bump om oude (kapotte) state te negeren
const POS = ['Aanvaller','Middenvelder','Verdediger'];
const DEFAULT_ORDER = ['Dani','Twan','Sydney','Ryan','Finn','Milan','Diede','Wouter'];

let state = {
  quickSwapOut: null,      // id veld -> naar bank
  quickSwapIn:  null,      // id bank -> naar veld
  team: 'De Esch O9',
  formation: 5,
  players: [],
  keepersMode: 4,
  keeperByQuarter: [],
  q: 1,
  schedule: [],
  plannedMinutes: {},
  running: false,
  elapsedMs: 0,
  quarterMs: 10*60*1000,
  swapAtMs: 5*60*1000,
  swappedThisQuarter: false
};

/* ---------- STORAGE ---------- */
function uid(){ return Math.random().toString(36).slice(2,9); }
function save(){ try{ localStorage.setItem(storeKey, JSON.stringify(state)); }catch(e){} }
function load(){ try{ const raw = localStorage.getItem(storeKey); if(raw) state = JSON.parse(raw); }catch(e){} }

/* ---------- DEFAULTS ---------- */
function ensureDefaults(){
  if(!Array.isArray(state.players) || state.players.length === 0){
    state.players = DEFAULT_ORDER.map((n,i)=>({ id:uid(), name:n, pos:POS[i%3], present:true, benchCd:0 }));
  }
  if(!Array.isArray(state.keeperByQuarter) || state.keeperByQuarter.length !== 4){
    const ps = state.players.map(p=>p.id);
    state.keeperByQuarter = [ps[0]||null, ps[1]||ps[0]||null, ps[2]||ps[0]||null, ps[3]||ps[0]||null];
  }
  if(!state.q) state.q = 1;
}
function presentPlayers(){ return state.players.filter(p=>p.present); }
function playerBy(id){ return state.players.find(p=>p.id===id); }
function nameBy(id){ const p = playerBy(id); return p ? p.name : '‚Äî'; }
function rankIndex(id){ return state.players.findIndex(p=>p.id===id); }
function keeperFor(q){ return state.keeperByQuarter[q-1]; }

/* ---------- BANK-kwaliteitsregel ---------- */
function violatesQualityGap(arr){
  if(!arr || arr.length < 2) return false;
  for(let i=0;i<arr.length;i++){
    for(let j=i+1;j<arr.length;j++){
      if(Math.abs(rankIndex(arr[i]) - rankIndex(arr[j])) < 3) return true;
    }
  }
  return false;
}

/* ---------- KEEPER UI ---------- */
function keeperAssignUI(containerId,prefix){
  const row = document.getElementById(containerId);
  if(!row) return;
  row.innerHTML = '';
  const ps = presentPlayers();
  const opts = ps.map(p=>`<option value="${p.id}">${p.name}</option>`).join('');
  if(state.keepersMode === 1){
    const id=`${prefix}-all`;
    row.innerHTML = `<select id="${id}">${opts}</select>`;
    const el = document.getElementById(id);
    if(el) el.value = state.keeperByQuarter[0] || ps[0]?.id || '';
  }else if(state.keepersMode === 2){
    row.innerHTML = `
      <div class="grid2" style="width:100%">
        <div><label>1e helft</label><select id="${prefix}-h1">${opts}</select></div>
        <div><label>2e helft</label><select id="${prefix}-h2">${opts}</select></div>
      </div>`;
    const a = document.getElementById(`${prefix}-h1`);
    const b = document.getElementById(`${prefix}-h2`);
    if(a) a.value = state.keeperByQuarter[0] || ps[0]?.id || '';
    if(b) b.value = state.keeperByQuarter[2] || ps[1]?.id || ps[0]?.id || '';
  }else{
    const ids=[`${prefix}-q1`,`${prefix}-q2`,`${prefix}-q3`,`${prefix}-q4`];
    row.innerHTML = `
      <div class="grid2" style="width:100%">
        ${ids.map((id,i)=>`<div><label>Kwart ${i+1}</label><select id="${id}">${opts}</select></div>`).join('')}
      </div>`;
    ids.forEach((id,i)=>{ const el = document.getElementById(id); if(el) el.value = state.keeperByQuarter[i] || ps[i]?.id || ps[0]?.id || ''; });
  }
}
function readKeeperAssign(prefix){
  const ps = presentPlayers();
  const val = id => { const el = document.getElementById(id); return el ? el.value : (ps[0]?.id||null); };
  if(state.keepersMode === 1){
    const k = val(`${prefix}-all`); state.keeperByQuarter = [k,k,k,k];
  }else if(state.keepersMode === 2){
    const a = val(`${prefix}-h1`), b = val(`${prefix}-h2`); state.keeperByQuarter = [a,a,b,b];
  }else{
    state.keeperByQuarter = [val(`${prefix}-q1`),val(`${prefix}-q2`),val(`${prefix}-q3`),val(`${prefix}-q4`)];
  }
}

/* ---------- PLANNER ---------- */
function applySlotMinutes(r){
  [...r.field, r.keeper].forEach(id => { state.plannedMinutes[id] = (state.plannedMinutes[id]||0) + 5; });
  presentPlayers().forEach(p => { if(p.id===r.keeper) return; p.benchCd = r.bench.includes(p.id) ? 1 : 0; });
}

function buildSlot(q,slot,k,prevField){
  const all = presentPlayers().map(p=>p.id).filter(id=>id!==k);
  const mustPlay = all.filter(id => playerBy(id).benchCd > 0);
  let field = mustPlay.slice();

  const need = Math.max(0, state.formation - field.length);
  const add = all.filter(id=>!field.includes(id))
    .sort((a,b)=>{
      const da=(state.plannedMinutes[a]||0)-(state.plannedMinutes[b]||0);
      return da!==0 ? da : rankIndex(a)-rankIndex(b);
    }).slice(0,need);
  field = field.concat(add);

  let bench = all.filter(id => !field.includes(id));

  if(violatesQualityGap(bench)){
    const candidates = field.filter(id=>!mustPlay.includes(id))
      .sort((a,b)=>{
        const da=(state.plannedMinutes[b]||0)-(state.plannedMinutes[a]||0);
        return da!==0 ? da : rankIndex(b)-rankIndex(a);
      });
    outer: for(const bId of bench.slice()){
      for(const fId of candidates){
        const nf = field.map(x=>x===fId?bId:x);
        const nb = bench.map(x=>x===bId?fId:x);
        if(!violatesQualityGap(nb)){ field=nf; bench=nb; break outer; }
      }
    }
  }

  let out=[], inn=[];
  if(prevField){ out = prevField.filter(id=>!field.includes(id)); inn = field.filter(id=>!prevField.includes(id)); }

  return { q, slot, start:(slot===1?0:5), end:(slot===1?5:10), keeper:k, field:field.slice(), bench:bench.slice(), out, inn };
}

function recomputeAll(){
  state.schedule = []; state.plannedMinutes = {};
  state.players.forEach(p=>{ p.benchCd = p.benchCd||0; state.plannedMinutes[p.id]=0; });
  let prevField = null;
  for(let q=1;q<=4;q++){
    const k = keeperFor(q);
    const s1 = buildSlot(q,1,k,prevField); applySlotMinutes(s1); state.schedule.push(s1);
    const s2 = buildSlot(q,2,k,s1.field);  applySlotMinutes(s2); state.schedule.push(s2);
    prevField = s2.field.slice();
  }
  state.swappedThisQuarter = false;
  state.elapsedMs = 0;
  save();
}

/* Minuten/cooldowns t/m index herrekenen (voor herstartpunt) */
function recomputeMinutesUpToIndex(lastIdx){
  state.plannedMinutes = {};
  state.players.forEach(p=> state.plannedMinutes[p.id]=0);
  presentPlayers().forEach(p=> p.benchCd = 0);
  for(let i=0;i<=lastIdx;i++){ applySlotMinutes(state.schedule[i]); }
}

/* Schema opnieuw opbouwen vanaf kwart, met optionele geforceerde s2 */
function rebuildScheduleFromQuarter(startQ, forcedS2){
  const idxS1=(startQ-1)*2, idxS2=idxS1+1;

  recomputeMinutesUpToIndex(idxS1-1);

  const kStart = keeperFor(startQ);
  let s1 = state.schedule[idxS1];
  if(!s1 || s1.q!==startQ || s1.slot!==1){
    const prevField = (idxS1-1>=0) ? state.schedule[idxS1-1].field.slice() : null;
    s1 = buildSlot(startQ,1,kStart,prevField);
  }
  state.schedule[idxS1] = s1; applySlotMinutes(s1);

  let s2 = forcedS2 ? { ...forcedS2, q:startQ, slot:2, keeper:kStart }
                    : buildSlot(startQ,2,kStart,s1.field);
  state.schedule[idxS2] = s2; applySlotMinutes(s2);

  let prevField = s2.field.slice();
  for(let q=startQ+1; q<=4; q++){
    const k = keeperFor(q);
    const i1=(q-1)*2, i2=i1+1;
    const ns1=buildSlot(q,1,k,prevField); state.schedule[i1]=ns1; applySlotMinutes(ns1);
    const ns2=buildSlot(q,2,k,ns1.field); state.schedule[i2]=ns2; applySlotMinutes(ns2);
    prevField = ns2.field.slice();
  }
  save();
}

/* ---------- DRAG SORT ---------- */
function makeSortable(container){
  let dragged=null, placeholder=null;

  const onMove=(e)=>{
    if(!dragged) return; e.preventDefault();
    const y = (e.clientY ?? (e.touches && e.touches[0]?.clientY) ?? 0);
    const items=[...container.querySelectorAll('.player')].filter(el=>el!==dragged);
    let target=null;
    for(const el of items){
      const r=el.getBoundingClientRect();
      if(y>r.top && y<r.bottom){ target=el; break; }
    }
    if(target && placeholder){
      const r=target.getBoundingClientRect();
      if(y<r.top + r.height/2) container.insertBefore(placeholder, target);
      else container.insertBefore(placeholder, target.nextSibling);
    }
  };

  const onUp=()=>{
    if(!dragged) return;
    dragged.classList.remove('dragging');
    if(placeholder && placeholder.parentNode){
      placeholder.parentNode.insertBefore(dragged, placeholder);
      placeholder.remove();
    }
    placeholder=null;

    const ids=[...container.querySelectorAll('.player')].map(el=>el.dataset.id);
    state.players = ids.map(id=>state.players.find(p=>p.id===id));
    save();

    window.removeEventListener('pointermove', onMove, {passive:false});
    window.removeEventListener('pointerup', onUp);
    window.removeEventListener('pointercancel', onUp);
    dragged=null;
  };

  container.querySelectorAll('.player').forEach(el=>{
    const handle = el.querySelector('.drag') || el;
    handle.addEventListener('pointerdown', (e)=>{
      dragged=el; dragged.classList.add('dragging');
      placeholder=document.createElement('div'); placeholder.className='placeholder';
      placeholder.style.height = el.getBoundingClientRect().height + 'px';
      container.insertBefore(placeholder, el.nextSibling);
      e.preventDefault();
      window.addEventListener('pointermove', onMove, {passive:false});
      window.addEventListener('pointerup', onUp);
      window.addEventListener('pointercancel', onUp);
    }, {passive:false});
  });
}

function currentSlots(){
  const r1 = state.schedule.find(r=>r.q===state.q && r.slot===1);
  const r2 = state.schedule.find(r=>r.q===state.q && r.slot===2);
  return { r1, r2 };
}

/* ---------- RENDER ---------- */
function renderPlayersList(){
  const list = document.getElementById('playerList');
  if(!list) return;
  list.innerHTML='';
  state.players.forEach(p=>{
    const el=document.createElement('div'); el.className='player'; el.dataset.id=p.id;
    el.innerHTML = `
      <div class="drag">‚ò∞</div>
      <div class="name" contenteditable="true">${p.name}</div>
      <select class="pos">${POS.map(x=>`<option ${x===p.pos?'selected':''}>${x}</option>`).join('')}</select>
      <div class="present"><input type="checkbox" ${p.present?'checked':''}></div>
      <div class="del"><button class="btn small danger">üóë</button></div>`;
    el.querySelector('.name').addEventListener('input',e=>{ p.name=e.target.textContent.trim(); save(); });
    el.querySelector('.pos').addEventListener('change',e=>{ p.pos=e.target.value; save(); });
    el.querySelector('.present input').addEventListener('change',e=>{ p.present=e.target.checked; save(); });
    el.querySelector('.del button').addEventListener('click',()=>{ state.players = state.players.filter(x=>x.id!==p.id); save(); renderPlayersList(); });
    list.appendChild(el);
  });
  makeSortable(list);
}

function renderSetup(){
  const tn=document.getElementById('teamName'); if(tn) tn.value=state.team;
  const fm=document.getElementById('formation'); if(fm) fm.value=String(state.formation);
  const km=document.getElementById('keepersMode'); if(km) km.value=String(state.keepersMode);
  keeperAssignUI('keeperAssignRow','keepk');
  renderPlayersList();
}

function renderLive(){
  const lbl=document.getElementById('lblQuarter'); if(lbl) lbl.textContent = `Kwart ${state.q} / 4`;
  const { r1, r2 } = currentSlots();
  const lk=document.getElementById('liveKeeper'); if(lk) lk.textContent = nameBy(r1?.keeper)||'‚Äî';
  const lf=document.getElementById('liveField');  if(lf) lf.textContent = (r1?.field||[]).map(nameBy).join(', ')||'‚Äî';
  const lb=document.getElementById('liveBench');  if(lb) lb.textContent = (r1?.bench||[]).map(nameBy).join(', ')||'‚Äî';
  const lo=document.getElementById('liveSwapOut'); if(lo) lo.textContent = (r2?.out||[]).map(nameBy).join(', ')||'‚Äî';
  const li=document.getElementById('liveSwapIn');  if(li) li.textContent = (r2?.inn||[]).map(nameBy).join(', ')||'‚Äî';

  const tb = document.querySelector('#scheduleTable tbody'); 
  if(tb){
    tb.innerHTML='';
    [r1,r2].filter(Boolean).forEach(r=>{
      const tr=document.createElement('tr');
      tr.innerHTML = `<td>${r.q}‚Ä¢${r.slot}</td><td>${String(r.start).padStart(2,'0')}-${String(r.end).padStart(2,'0')}m</td><td>${r.field.map(nameBy).join(', ')}</td><td>${r.bench.map(nameBy).join(', ')}</td>`;
      tb.appendChild(tr);
    });
  }
  updateTimerUI();
}

function renderQuick(){
  const cont=document.getElementById('quickActive');
  if(cont){
    cont.innerHTML='';
    state.players.forEach(p=>{
      const line=document.createElement('div'); line.className='player';
      line.innerHTML=`<div class="name" style="flex:1">${p.name}</div><div class="present"><input type="checkbox" ${p.present?'checked':''}></div>`;
      line.querySelector('input').addEventListener('change',e=>{ p.present=e.target.checked; save(); });
      cont.appendChild(line);
    });
  }
  const qf=document.getElementById('quickFormation'); if(qf){ qf.innerHTML=['4','5','6'].map(v=>`<option value="${v}">${v}</option>`).join(''); qf.value=String(state.formation); }
  keeperAssignUI('quickKeeperAssign','quickk');
  renderQuickSwapCols();
}

function renderDist(){
  const body=document.querySelector('#distSwaps tbody');
  if(body){
    body.innerHTML='';
    state.schedule.forEach(r=>{
      const tr=document.createElement('tr');
      tr.innerHTML=`<td>${r.q}‚Ä¢${r.slot}</td><td>${String(r.start).padStart(2,'0')}-${String(r.end).padStart(2,'0')}m</td><td>${nameBy(r.keeper)}</td><td>${r.field.map(nameBy).join(', ')}</td><td>${r.bench.map(nameBy).join(', ')}</td>`;
      body.appendChild(tr);
    });
  }
  const mins=document.querySelector('#distMinutes tbody');
  if(mins){
    mins.innerHTML='';
    const rows=state.players.map(p=>({id:p.id,name:p.name,m:state.plannedMinutes[p.id]||0})).sort((a,b)=>b.m-a.m);
    const total=rows.reduce((s,x)=>s+x.m,0)||1; const avg=total/rows.length;
    rows.forEach(e=>{
      const tr=document.createElement('tr');
      const pct=Math.min(100,(e.m/(avg||1))*100);
      tr.innerHTML=`<td>${e.name}</td><td>${e.m} min</td><td><div class="bar"><div style="width:${pct}%"></div></div></td>`;
      mins.appendChild(tr);
    });
  }
}

/* ---------- Snelle wissel ‚Äì chips ---------- */
function renderQuickSwapCols(){
  const { r1, r2 } = currentSlots();
  const fieldBox=document.getElementById('quickFieldChips');
  const benchBox=document.getElementById('quickBenchChips');
  if(!r1 || !r2 || !fieldBox || !benchBox) return;

  // Default alleen als niets geselecteerd is:
  if(state.quickSwapOut === null) state.quickSwapOut = r1.field[0] || null;
  if(state.quickSwapIn  === null) state.quickSwapIn  = r1.bench[0] || null;

  fieldBox.innerHTML = r1.field.map(id=>{
    const staged = (id===state.quickSwapOut) ? ' staged' : '';
    return `<div class="chip${staged}" data-id="${id}" data-where="field">
              <div class="who">${nameBy(id)}</div>
              <div class="act"><button class="btn-move btn-to-bench" data-action="toBench">‚Üí bank</button></div>
            </div>`;
  }).join('');

  benchBox.innerHTML = r1.bench.map(id=>{
    const staged = (id===state.quickSwapIn) ? ' staged' : '';
    return `<div class="chip${staged}" data-id="${id}" data-where="bench">
              <div class="who">${nameBy(id)}</div>
              <div class="act"><button class="btn-move btn-to-field" data-action="toField">‚Üí veld</button></div>
            </div>`;
  }).join('');
}

/* E√©n handler: klik op chip OF op knopje werkt */
(function bindQuickSwapHandlers(){
  const container = document.getElementById('quickSwapCols');
  if(!container) return;

  container.addEventListener('click', (e)=>{
    const chip = e.target.closest('.chip');
    if(!chip) return;
    const id    = chip.getAttribute('data-id');
    const where = chip.getAttribute('data-where');
    const btn   = e.target.closest('.btn-move');
    const act   = btn ? btn.getAttribute('data-action') : (where==='field' ? 'toBench' : 'toField');

    if(where==='field' && act==='toBench'){ state.quickSwapOut = id; save(); renderQuickSwapCols(); }
    if(where==='bench' && act==='toField'){ state.quickSwapIn  = id; save(); renderQuickSwapCols(); }
  });
})();

/* ---------- TIMER + PROGRESS ---------- */
function fmt(ms){ const t=Math.max(0,Math.ceil((state.quarterMs-ms)/1000)); const m=Math.floor(t/60); const s=String(t%60).padStart(2,'0'); return `${m}:${s}`; }
function updateTimerUI(){
  const clock=document.getElementById('clock'); if(clock) clock.textContent = fmt(state.elapsedMs);
  const quarterMs=state.quarterMs, totalMs=4*quarterMs, totalElapsed=(state.q-1)*quarterMs + state.elapsedMs;
  const fill=document.getElementById('matchFill'); if(fill) fill.style.width = Math.min(100,(totalElapsed/totalMs)*100)+'%';
  const pctInQuarter=Math.min(100,(state.elapsedMs/quarterMs)*100);
  const marker=document.getElementById('quarterMarker'); if(marker) marker.style.left = ((state.q-1)*25 + pctInQuarter*0.25)+'%';
}

let tick=null;
function start(){
  if(state.running) return;
  state.running = true;
  const base = Date.now() - state.elapsedMs;
  tick = setInterval(()=>{
    state.elapsedMs = Date.now() - base;

    if(!state.swappedThisQuarter && state.elapsedMs >= state.swapAtMs){
      showSwap(); state.swappedThisQuarter = true;
    }
    if(state.elapsedMs >= state.quarterMs){
      state.elapsedMs = state.quarterMs; pause();
      if(state.q < 4){
        state.q += 1; state.elapsedMs = 0; state.swappedThisQuarter=false;
        renderLive();
      }
      save(); return;
    }
    updateTimerUI();
  }, 200);
}
function pause(){ state.running=false; if(tick){clearInterval(tick); tick=null;} save(); }
function showSwap(){
  const r = state.schedule.find(x=>x.q===state.q && x.slot===2);
  const out=(r?.out||[]).map(nameBy), inn=(r?.inn||[]).map(nameBy);
  const so=document.getElementById('swapOut'); const si=document.getElementById('swapIn');
  if(so) so.innerHTML = out.length?out.map(n=>`<div class="namechip">${n}</div>`).join(''):'<div class="namechip">‚Äî</div>';
  if(si) si.innerHTML = inn.length?inn.map(n=>`<div class="namechip">${n}</div>`).join(''):'<div class="namechip">‚Äî</div>';
  const ov=document.getElementById('swapOverlay'); if(ov) ov.style.display='flex';
  try{ navigator.vibrate && navigator.vibrate([120,80,120]); }catch(e){}
}
function hideSwap(){ const ov=document.getElementById('swapOverlay'); if(ov) ov.style.display='none'; try{ navigator.vibrate && navigator.vibrate([60]); }catch(e){} }

/* ---------- EVENTS ---------- */
document.querySelectorAll('.tab button').forEach(btn=>{
  btn.addEventListener('click', ()=>{
    document.querySelectorAll('.tab button').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    ['tab-setup','tab-live','tab-quick','tab-dist'].forEach(id=>document.getElementById(id)?.classList.add('hidden'));
    const id = btn.dataset.tab==='setup'?'tab-setup' : btn.dataset.tab==='live'?'tab-live' : btn.dataset.tab==='quick'?'tab-quick' : 'tab-dist';
    document.getElementById(id)?.classList.remove('hidden');
    if(id==='tab-setup') renderSetup();
    if(id==='tab-live')  renderLive();
    if(id==='tab-quick') renderQuick();
    if(id==='tab-dist')  renderDist();
  });
});

document.getElementById('btnAdd')?.addEventListener('click', ()=>{
  state.players.push({ id:uid(), name:'Nieuwe speler', pos:'Aanvaller', present:true, benchCd:0 });
  save(); renderPlayersList();
});
document.getElementById('btnReset')?.addEventListener('click', ()=>{
  if(!confirm('Team resetten naar vaste 8 spelers?')) return;
  state.players = DEFAULT_ORDER.map((n,i)=>({ id:uid(), name:n, pos:POS[i%3], present:true, benchCd:0 }));
  const ps=state.players.map(p=>p.id);
  state.keeperByQuarter=[ps[0],ps[1]||ps[0],ps[2]||ps[0],ps[3]||ps[0]];
  recomputeAll(); document.querySelector('.tab button[data-tab="live"]')?.click(); renderLive();
});
document.getElementById('keepersMode')?.addEventListener('change', ()=>{
  state.keepersMode = Number(document.getElementById('keepersMode').value)||1;
  keeperAssignUI('keeperAssignRow','keepk'); save();
});
document.getElementById('btnSaveSetup')?.addEventListener('click', ()=>{
  state.team = document.getElementById('teamName').value.trim() || 'Team';
  state.formation = Number(document.getElementById('formation').value) || 5;
  state.keepersMode = Number(document.getElementById('keepersMode').value) || 1;
  readKeeperAssign('keepk'); recomputeAll(); renderLive(); renderDist();
  document.querySelector('.tab button[data-tab="live"]')?.click();
});
document.getElementById('btnQuickRecalc')?.addEventListener('click', ()=>{
  const qf=document.getElementById('quickFormation'); if(qf) state.formation = Number(qf.value) || state.formation;
  readKeeperAssign('quickk'); recomputeAll(); renderLive(); renderDist(); renderQuick();
  document.querySelector('.tab button[data-tab="live"]')?.click();
});
document.getElementById('btnQuickToLive')?.addEventListener('click', ()=>{
  document.querySelector('.tab button[data-tab="live"]')?.click(); renderLive();
});

/* Pas wissel aan (hele wedstrijd herverdelen vanaf huidig kwart) */
function applyManualSwapForCurrentQuarter(){
  const { r1 } = currentSlots();
  if(!r1) return;

  const outId = state.quickSwapOut;
  const inId  = state.quickSwapIn;
  if(!outId || !inId || outId===inId) return;

  const newField = r1.field.map(id => id===outId ? inId : id);
  const all = presentPlayers().map(p=>p.id).filter(id=>id!==r1.keeper);
  const newBench = all.filter(id=>!newField.includes(id));

  const forcedS2 = { start:5, end:10, field:newField, bench:newBench, out:[outId], inn:[inId] };

  rebuildScheduleFromQuarter(state.q, forcedS2);

  // selectie behouden (niet naar ‚Äúbovenste‚Äù springen); pas resetten als je wilt
  // state.quickSwapOut = null; state.quickSwapIn = null;

  renderLive(); renderDist(); renderQuickSwapCols();
}
document.getElementById('btnApplyManualSwap')?.addEventListener('click', applyManualSwapForCurrentQuarter);

/* Timer knoppen + overlay */
document.getElementById('btnStart')?.addEventListener('click', start);
document.getElementById('btnPause')?.addEventListener('click', pause);
document.getElementById('btnDidSwap')?.addEventListener('click', hideSwap);

/* ---------- INIT ---------- */
load(); ensureDefaults(); recomputeAll(); renderSetup(); updateTimerUI();
</script>
</body>
</html>
