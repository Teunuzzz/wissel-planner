<!doctype html>
<html lang="nl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Wisselplanner O9</title>
<style>
  :root{
    --bg:#0d1422;
    --panel:#0f172a;
    --muted:#94a3b8;
    --text:#e5e7eb;
    --accent:#2b67f6;
    --accent-2:#1f2937;
    --chip:#0b1220;
    --ok:#16a34a;
    --warn:#f59e0b;
    --bad:#ef4444;
    --card:#0e1626;
    --border:#1f2937;
    --pill:#0b1220;
  }
  html,body{height:100%}
  body{
    margin:0;background:var(--bg);color:var(--text);font:16px/1.4 system-ui,Segoe UI,Roboto,Helvetica,Arial;
  }
  .container{max-width:1200px;margin:0 auto;padding:16px}
  .tabs{display:flex;gap:8px;margin:8px 0 16px}
  .tab-btn{padding:10px 14px;border-radius:10px;background:var(--panel);border:1px solid var(--border);cursor:pointer}
  .tab-btn.active{background:var(--accent);border-color:transparent}
  .card{background:var(--panel);border:1px solid var(--border);border-radius:16px;padding:16px;margin-bottom:16px}
  h1{margin:4px 0 12px;font-size:22px}
  h2{margin:0 0 12px;font-size:18px}
  .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
  .chip{background:var(--pill);border:1px solid var(--border);padding:8px 12px;border-radius:999px}
  .chip.on{outline:2px solid var(--accent)}
  .btn{background:var(--accent);border:none;color:white;padding:12px 16px;border-radius:12px;font-weight:600;cursor:pointer}
  .btn.secondary{background:var(--accent-2)}
  .btn.warn{background:var(--bad)}
  .btn.icon{padding:8px 10px}
  .grid{display:grid;grid-template-columns:160px 1fr;gap:8px;align-items:center}
  label{color:var(--muted)}
  select,input[type="text"],input[type="number"]{
    background:#0b1220;color:var(--text);border:1px solid var(--border);border-radius:10px;padding:10px 12px;min-width:120px
  }
  .list{display:flex;gap:8px;flex-wrap:wrap}
  .pill{background:#0b1220;border:1px solid var(--border);border-radius:999px;padding:8px 12px}
  .split{display:grid;grid-template-columns:1fr 1fr;gap:16px}
  .table{width:100%;border-collapse:collapse;margin-top:8px}
  .table th,.table td{border-top:1px solid var(--border);padding:10px 8px;text-align:left}
  .muted{color:var(--muted)}
  .right{margin-left:auto}
</style>
</head>
<body>
  <div class="container">
    <h1>Wisselplanner O9</h1>

    <div class="tabs">
      <button class="tab-btn active" data-tab="live">Live</button>
      <button class="tab-btn" data-tab="wijzig">Snelle wijzigingen</button>
      <button class="tab-btn" data-tab="setup">Setup</button>
      <span class="right"></span>
      <button id="btnClear" class="btn warn">App leegmaken</button>
    </div>

    <!-- LIVE -->
    <section id="tab-live" class="card">
      <h2>Tijdens de wedstrijd</h2>
      <div class="row">
        <div class="chip"><strong>Kwart:</strong> <span id="lblQuarter">1/4</span></div>
        <div class="chip"><strong>Tijd:</strong> <span id="lblTime">00:00</span></div>
        <button class="btn icon" id="btnPlay">‚ñ∂</button>
        <button class="btn icon secondary" id="btnPause">‚è∏</button>
        <button class="btn icon secondary" id="btnReset">üîÅ</button>
        <button class="btn icon" id="btnWhistle">üîî Wissel NU</button>
      </div>

      <div class="row" style="margin-top:12px">
        <div class="chip"><strong>Keeper:</strong> <span id="lblKeeper">-</span></div>
        <div class="chip"><strong>Veld:</strong> <span id="lblField">-</span></div>
        <div class="chip"><strong>Bank:</strong> <span id="lblBench">-</span></div>
      </div>

      <table class="table" id="tblSchedule">
        <thead><tr><th>Slot</th><th>Tijd</th><th>Keeper</th><th>Veld</th><th>Bank</th></tr></thead>
        <tbody></tbody>
      </table>
    </section>

    <!-- WIJZIG -->
    <section id="tab-wijzig" class="card" style="display:none">
      <h2>Snelle wijzigingen</h2>
      <div class="split">
        <div>
          <div class="grid">
            <label>Keeper</label>
            <select id="selKeeper"></select>
            <label>Formatie (aantal veldspelers)</label>
            <input type="number" id="inpFormation" min="4" max="9">
          </div>
          <div style="height:8px"></div>
          <div class="grid">
            <label>Op veld</label>
            <div class="list" id="badgesField"></div>
            <label>Bank</label>
            <div class="list" id="badgesBench"></div>
          </div>
        </div>
        <div>
          <div class="grid">
            <label>Snelle actie</label>
            <div class="row">
              <select id="selSwapOut"></select>
              <span class="muted">‚Üî</span>
              <select id="selSwapIn"></select>
              <button class="btn secondary" id="btnSwap">Wissel</button>
            </div>
            <label>Speler stopt</label>
            <div class="row">
              <select id="selStop"></select>
              <button class="btn secondary" id="btnStop">Verwijder uit selectie</button>
            </div>
          </div>
        </div>
      </div>
      <div class="row" style="margin-top:12px">
        <button class="btn" id="btnApply">Toepassen</button>
        <button class="btn" id="btnRecalc">Herberekenen</button>
      </div>
    </section>

    <!-- SETUP -->
    <section id="tab-setup" class="card" style="display:none">
      <h2>Setup</h2>
      <div class="grid">
        <label>Teamnaam</label> <input id="inpTeam" type="text" placeholder="Teamnaam">
        <label>Spelers</label>
        <div id="listPlayers" class="list"></div>
      </div>
      <div class="row" style="margin-top:12px">
        <button class="btn" id="btnAddPlayer">Speler toevoegen</button>
        <button class="btn secondary" id="btnSaveSetup">Opslaan</button>
      </div>
    </section>
  </div>

<script>
// ------------------------ STATE ------------------------
const storeKey = 'wisselplanner.v3';
let state = {
  team: 'De Esch O9',
  formation: 5,                   // veldspelers
  players: [],                    // {id,name,present:true}
  keeperId: null,
  field: [],                      // ids
  bench: [],                      // ids
  quarter: 1,
  slotMinutes: 5,
  slotsPerQuarter: 2,
  lastBenchMap: {},               // id -> cooldown slots remaining
  schedule: []                    // computed
};

// ------------------------ INIT ------------------------
function uid(){return Math.random().toString(36).slice(2,9)}
function save(){localStorage.setItem(storeKey, JSON.stringify(state))}
function load(){
  const s = localStorage.getItem(storeKey);
  if (s){ state = JSON.parse(s); }
  else { initBase8(); save(); }
}
function initBase8(){
  const names = ['Sydney','Wouter','Finn','Dani','Ryan','Milan','Twan','Diede'];
  state.players = names.map(n=>({id:uid(),name:n,present:true}));
  state.keeperId = state.players[0].id;
  // fill field & bench from formation
  state.formation = 5;
  state.field = state.players.slice(1, 1+state.formation).map(p=>p.id);
  state.bench = state.players.slice(1+state.formation).map(p=>p.id);
  state.lastBenchMap = {};
  state.quarter = 1;
  state.schedule = [];
}

function clearAndInit(){
  localStorage.removeItem(storeKey);
  initBase8();
  save();
  renderAll();
  gotoTab('setup');
}

// ------------------------ UI: Tabs ------------------------
const tabButtons = document.querySelectorAll('.tab-btn');
tabButtons.forEach(b=>b.addEventListener('click',()=>{
  gotoTab(b.dataset.tab);
}));

function gotoTab(name){
  tabButtons.forEach(b=>b.classList.toggle('active', b.dataset.tab===name));
  document.getElementById('tab-live').style.display   = name==='live'?'block':'none';
  document.getElementById('tab-wijzig').style.display = name==='wijzig'?'block':'none';
  document.getElementById('tab-setup').style.display  = name==='setup'?'block':'none';
}

// ------------------------ RENDER ------------------------
function renderAll(){
  renderSetup();
  renderWijzig();
  recomputeAndRenderLive();
}

function renderSetup(){
  document.getElementById('inpTeam').value = state.team;
  const list = document.getElementById('listPlayers');
  list.innerHTML = '';
  state.players.forEach(p=>{
    const el = document.createElement('span');
    el.className = 'pill';
    el.textContent = p.name + (p.present?'':' (afwezig)');
    el.style.cursor = 'pointer';
    el.onclick = ()=>{ p.present = !p.present; save(); renderSetup(); };
    list.appendChild(el);
  });
}

function renderWijzig(){
  // selects
  fillSelect('selKeeper', presentPlayers().map(p=>({value:p.id,label:p.name})), state.keeperId);
  document.getElementById('inpFormation').value = state.formation;
  // badges field/bench
  setBadges('badgesField', state.field);
  setBadges('badgesBench', state.bench);
  // quick swap lists
  const all = presentPlayers();
  fillSelect('selSwapOut', state.field.map(id=>({value:id,label:nameById(id)})));
  fillSelect('selSwapIn', state.bench.map(id=>({value:id,label:nameById(id)})));
  fillSelect('selStop', all.map(p=>({value:p.id,label:p.name})));
}

function recomputeAndRenderLive(){
  // ensure constraints then compute schedule
  ensureKeeperExclusive();
  enforceTwoBenchGapDecay(); // decay cooldown each slot recompute (visual only)
  generateSchedule(); // produces state.schedule
  // header
  document.getElementById('lblQuarter').textContent = `${state.quarter}/4`;
  document.getElementById('lblTime').textContent = '00:00';
  document.getElementById('lblKeeper').textContent = nameById(state.keeperId)||'-';
  document.getElementById('lblField').textContent  = state.field.map(nameById).join(', ')||'-';
  document.getElementById('lblBench').textContent  = state.bench.map(nameById).join(', ')||'-';
  // table
  const tb = document.querySelector('#tblSchedule tbody');
  tb.innerHTML='';
  state.schedule.forEach((row,i)=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>Q${row.q} ‚Ä¢ ${row.slot}</td>
      <td>${row.time}</td>
      <td>${row.keeper.map(nameById).join(', ')}</td>
      <td>${row.field.map(nameById).join(', ')}</td>
      <td>${row.bench.map(nameById).join(', ')}</td>`;
    tb.appendChild(tr);
  });
}

// ------------------------ HELPERS ------------------------
function presentPlayers(){ return state.players.filter(p=>p.present); }
function nameById(id){ const p = state.players.find(x=>x.id===id); return p?p.name:'?'; }
function fillSelect(id, items, value){
  const sel = document.getElementById(id);
  sel.innerHTML='';
  items.forEach(it=>{
    const opt = document.createElement('option'); opt.value = it.value; opt.textContent = it.label; sel.appendChild(opt);
  });
  if (value) sel.value = value;
}
function setBadges(containerId, ids){
  const box = document.getElementById(containerId);
  box.innerHTML='';
  ids.forEach(id=>{
    const el = document.createElement('span');
    el.className = 'chip'; el.textContent = nameById(id);
    box.appendChild(el);
  });
}

// Keeper mag nooit dubbel in veld/bank staan
function ensureKeeperExclusive(){
  const k = state.keeperId;
  if (!k) return;
  state.field = state.field.filter(id=>id!==k);
  state.bench = state.bench.filter(id=>id!==k);
}

// Two-turn bench gap utilities
function enforceTwoBenchGapOnBenchPlayers(newBench){
  // Reduce cooldown for all, then set cooldown=2 for players just benched
  const map = state.lastBenchMap || {};
  Object.keys(map).forEach(id=>{ map[id] = Math.max(0,(map[id]||0)); });
  // set cooldown for those in new bench who just moved from field
  newBench.forEach(id=>{
    if (!map[id]) map[id]=0;
  });
  state.lastBenchMap = map;
}

function enforceTwoBenchGapDecay(){
  // For display recompute: decay doesn't change here; actual application happens during rotation
  if (!state.lastBenchMap) state.lastBenchMap = {};
}

function canBenchAgain(id){
  const cd = state.lastBenchMap?.[id]||0;
  return cd<=0;
}

function decrementBenchCooldownFor(idsJustPlayed){
  // After each slot, every player who was *benched* gets their cooldown decreased by 1 (down to 0)
  const map = state.lastBenchMap || {};
  Object.keys(map).forEach(id=>{
    map[id] = Math.max(0, map[id] - 1);
  });
  state.lastBenchMap = map;
}

function nextRotation(currentField, currentBench){
  // naive rotation: swap first bench who can play with first field who can sit
  const f = [...currentField];
  const b = [...currentBench];
  // choose field out: first who can be benched (cooldown==0) and is not keeper
  const outIdx = f.findIndex(id => id!==state.keeperId);
  // choose bench in: first bench player
  const inIdx = b.findIndex(id => true);
  if (outIdx>=0 && inIdx>=0){
    const out = f[outIdx], inn = b[inIdx];
    f[outIdx] = inn;
    b[inIdx] = out;
  }
  return {field:f, bench:b};
}

// ------------------------ SCHEDULE ------------------------
function generateSchedule(){
  // Simple schedule of 2 slots per quarter based on current field/bench
  const slots = state.slotsPerQuarter;
  const minutes = state.slotMinutes;
  const sched = [];
  let field = [...state.field];
  let bench = [...state.bench];
  // Start row
  for (let q=1;q<=1;q++){ // only display current quarter for simplicity
    for (let s=1;s<=slots;s++){
      const start = (s-1)*minutes;
      const end   = s*minutes;
      sched.push({
        q, slot:s,
        time: `${String(start).padStart(2,'0')}-${String(end).padStart(2,'0')}m`,
        keeper:[state.keeperId],
        field:[...field],
        bench:[...bench]
      });
      // rotate for next slot with simple logic, but maintain 2-slot bench gap:
      // Players who were benched this slot decrement cooldown by 1
      decrementBenchCooldownFor(field);
      // produce next rotation
      const nx = nextRotation(field, bench);
      field = nx.field;
      bench = nx.bench;
      ensureKeeperExclusive();
    }
  }
  state.schedule = sched;
}

// ------------------------ ACTIONS ------------------------
function applyQuickChangesFromUI(){
  // keeper
  const newK = document.getElementById('selKeeper').value || null;
  if (newK) state.keeperId = newK;
  // formation
  const newForm = Math.max(4, Math.min(9, Number(document.getElementById('inpFormation').value||state.formation)));
  if (newForm !== state.formation){
    state.formation = newForm;
    // rebuild field from present players (excluding keeper), keep as many as possible
    const avail = presentPlayers().map(p=>p.id).filter(id=>id!==state.keeperId);
    state.field = avail.slice(0, state.formation);
    state.bench = avail.slice(state.formation);
  }
  // ensure keeper exclusivity
  ensureKeeperExclusive();
}

function onRecalcOrApply(){
  applyQuickChangesFromUI();
  // keep bench gap map consistent (simple approach keeps map; full algorithm depends on live engine)
  save();
  // recompute & render
  recomputeAndRenderLive();
  // go to live tab automatically
  gotoTab('live');
}

function swapOne(){
  const outId = document.getElementById('selSwapOut').value;
  const inId  = document.getElementById('selSwapIn').value;
  if (!outId || !inId) return;
  const idx = state.field.indexOf(outId);
  const jdx = state.bench.indexOf(inId);
  if (idx>=0 && jdx>=0){
    state.field[idx] = inId;
    state.bench[jdx] = outId;
    ensureKeeperExclusive();
    save();
    renderWijzig();
  }
}

function stopPlayer(){
  const id = document.getElementById('selStop').value;
  const p = state.players.find(x=>x.id===id);
  if (!p) return;
  p.present = false;
  state.field = state.field.filter(x=>x!==id);
  state.bench = state.bench.filter(x=>x!==id);
  if (state.keeperId===id){ state.keeperId = state.field[0] || state.bench[0] || null; }
  save();
  renderWijzig();
}

// ------------------------ EVENTS ------------------------
document.getElementById('btnApply').addEventListener('click', onRecalcOrApply);
document.getElementById('btnRecalc').addEventListener('click', onRecalcOrApply);
document.getElementById('btnSwap').addEventListener('click', swapOne);
document.getElementById('btnStop').addEventListener('click', stopPlayer);
document.getElementById('btnClear').addEventListener('click', clearAndInit);

// Live controls (non-functional timer demo)
document.getElementById('btnPlay').onclick = ()=>alert('Timer start (demo)');
document.getElementById('btnPause').onclick = ()=>alert('Timer pauze (demo)');
document.getElementById('btnReset').onclick = ()=>{ state.quarter=1; save(); recomputeAndRenderLive(); };

// ------------------------ START ------------------------
load();
renderAll();
gotoTab('live');
</script>
</body>
</html>
