<!doctype html>
<html lang="nl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<meta name="theme-color" content="#0d1422">
<link rel="manifest" href="manifest.webmanifest">
<title>Wisselplanner</title>
<style>
  :root{
    --bg:#0b1220;--panel:#0f172a;--border:#1f2937;--text:#e5e7eb;--muted:#9ca3af;
    --accent:#2b67f6;--danger:#ef4444;--ok:#16a34a;--warn:#f59e0b;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--text);font:16px/1.4 system-ui,Segoe UI,Roboto,Helvetica,Arial}
  .container{max-width:800px;margin:0 auto;padding:12px}
  h1{font-size:20px;margin:8px 0 12px}
  h2{font-size:18px;margin:8px 0 10px}
  .tabs{display:flex;gap:6px;position:sticky;top:0;background:var(--bg);padding:8px 0;z-index:10}
  .tab{flex:1;min-width:0}
  .tab button{width:100%;padding:12px;border-radius:12px;border:1px solid var(--border);background:var(--panel);color:var(--text);font-weight:600}
  .tab button.active{background:var(--accent);border-color:transparent}
  .card{background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:12px;margin:8px 0}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .btn{padding:12px 14px;border-radius:12px;border:none;background:var(--accent);color:#fff;font-weight:700}
  .btn.secondary{background:#1f2937}
  .btn.danger{background:var(--danger)}
  .btn.small{padding:8px 10px;font-weight:600}
  .pill{padding:8px 10px;border-radius:999px;border:1px solid var(--border);background:#0a1322}
  input,select{width:100%;padding:12px;border-radius:12px;border:1px solid var(--border);background:#0b1324;color:var(--text)}
  label{font-size:13px;color:var(--muted)}
  .grid{display:grid;grid-template-columns:1fr;gap:8px}
  @media(min-width:560px){.grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}}
  .list{display:flex;flex-direction:column;gap:8px}
  .player{display:flex;align-items:center;gap:8px;padding:10px;border:1px solid var(--border);border-radius:12px;background:#0b1324}
  .player .drag{cursor:grab;font-size:18px;opacity:.8}
  .player .name{flex:1;min-width:0}
  .player .pos{width:130px}
  .player .present{width:36px;text-align:center}
  .player .del{width:40px;text-align:center}
  .hidden{display:none}
  .table{width:100%;border-collapse:collapse}
  .table th,.table td{padding:10px;border-top:1px solid var(--border);text-align:left}
  .big{font-size:44px;font-weight:800;letter-spacing:1px}
  .timer{display:flex;align-items:center;gap:12px}
  .progress{height:10px;border-radius:999px;background:#0b1324;border:1px solid var(--border);overflow:hidden}
  .progress>div{height:100%;background:var(--accent);width:0%}
  .overlay{position:fixed;inset:0;background:rgba(0,0,0,.85);display:none;align-items:center;justify-content:center;z-index:50;padding:16px}
  .overlay .panel{max-width:560px;width:100%;background:#0f172a;border:1px solid var(--border);border-radius:16px;padding:16px;text-align:center}
  .swaplist{display:flex;gap:12px;justify-content:center;flex-wrap:wrap;margin:10px 0}
  .swaplist .col{flex:1 1 220px;background:#0b1324;border:1px solid var(--border);border-radius:12px;padding:12px}
  .swaplist h3{margin:0 0 8px;font-size:16px}
  .namechip{padding:10px;border:1px solid var(--border);border-radius:10px;margin:6px 0;background:#0a1322}
  .muted{color:var(--muted)}
  .footerNote{font-size:12px;color:var(--muted);text-align:center;margin-top:8px}
  .no-scroll-x{overflow-x:hidden}
</style>
</head>
<body class="no-scroll-x">
<div class="container">
  <h1>Wisselplanner</h1>
  <div class="tabs">
    <div class="tab"><button class="active" data-tab="setup">Setup &amp; Spelers</button></div>
    <div class="tab"><button data-tab="live">Live</button></div>
    <div class="tab"><button data-tab="quick">Snelle wijzigingen</button></div>
  </div>

  <!-- SETUP -->
  <section id="tab-setup" class="card">
    <h2>Team &amp; spelers</h2>
    <div class="grid2 card">
      <div>
        <label>Teamnaam</label>
        <input id="teamName" placeholder="Teamnaam">
      </div>
      <div>
        <label>Formatie (aantal veldspelers)</label>
        <select id="formation">
          <option value="4">4</option>
          <option value="5" selected>5</option>
          <option value="6">6</option>
        </select>
      </div>
      <div>
        <label>Keepers per wedstrijd</label>
        <select id="keepersMode">
          <option value="1">1 keeper (hele wedstrijd)</option>
          <option value="2">2 keepers (helften)</option>
          <option value="4">4 keepers (kwarten)</option>
        </select>
      </div>
      <div id="keeperAssignBox">
        <label>Keeper-keuze (volgens modus)</label>
        <div class="row" id="keeperAssignRow"></div>
      </div>
    </div>

    <div class="card">
      <div class="row" style="justify-content:space-between">
        <h2 style="margin:0">Spelers (sleep om te rangschikken)</h2>
        <button class="btn small" id="btnAdd">+ Speler</button>
      </div>
      <div id="playerList" class="list" aria-label="Sleep om volgorde te wijzigen"></div>
      <div class="footerNote">Bovenaan = beste, onderaan = minst sterk (ranking is onzichtbaar in UI).</div>
    </div>

    <div class="row">
      <button class="btn" id="btnSaveSetup">Opslaan & Naar Live</button>
      <button class="btn secondary" id="btnExport">Exporteer team</button>
      <button class="btn secondary" id="btnImport">Importeer team</button>
      <button class="btn danger" id="btnReset">App leegmaken</button>
    </div>
  </section>

  <!-- LIVE -->
  <section id="tab-live" class="card hidden">
    <h2>Live</h2>
    <div class="timer">
      <div class="big" id="clock">10:00</div>
      <div class="pill" id="lblQuarter">Kwart 1 / 4</div>
      <button class="btn" id="btnPlay">‚ñ∂ Start</button>
      <button class="btn secondary" id="btnPause">‚è∏Ô∏é Pauze</button>
      <button class="btn secondary" id="btnNext">Volgend kwart</button>
    </div>
    <div class="progress" aria-label="Voortgang kwart"><div id="progressBar"></div></div>

    <div class="card">
      <div class="row">
        <div class="pill"><strong>Keeper:</strong> <span id="liveKeeper">‚Äî</span></div>
        <div class="pill"><strong>Veld:</strong> <span id="liveField">‚Äî</span></div>
        <div class="pill"><strong>Bank:</strong> <span id="liveBench">‚Äî</span></div>
      </div>
    </div>

    <table class="table" id="scheduleTable">
      <thead><tr><th>Slot</th><th>Tijd</th><th>Veld</th><th>Bank</th></tr></thead>
      <tbody></tbody>
    </table>
  </section>

  <!-- QUICK -->
  <section id="tab-quick" class="card hidden">
    <h2>Snelle wijzigingen</h2>
    <div class="card">
      <div class="row">
        <div class="grid" style="flex:1;min-width:220px">
          <label>Actieve spelers</label>
          <div id="quickActive" class="list"></div>
        </div>
      </div>
    </div>
    <div class="grid2">
      <div>
        <label>Keeper wijzigen (volgens modus)</label>
        <div id="quickKeeperAssign" class="row"></div>
      </div>
      <div>
        <label>Formatie aanpassen</label>
        <select id="quickFormation"></select>
      </div>
    </div>
    <div class="row" style="margin-top:8px">
      <button class="btn" id="btnQuickRecalc">Herberekenen</button>
      <button class="btn secondary" id="btnQuickToLive">Naar Live</button>
    </div>
  </section>
</div>

<!-- Overlay voor wisselmoment -->
<div class="overlay" id="swapOverlay" role="dialog" aria-modal="true">
  <div class="panel">
    <h2>Wisselmoment</h2>
    <div class="swaplist">
      <div class="col">
        <h3>Uit</h3>
        <div id="swapOut"></div>
      </div>
      <div class="col">
        <h3>In</h3>
        <div id="swapIn"></div>
      </div>
    </div>
    <button class="btn" id="btnDidSwap">Gewisseld</button>
    <div class="footerNote">Na ‚ÄúGewisseld‚Äù gaat het scherm terug naar Live. De kwart-timer loopt door; er volgt geen nieuwe wissel in dit kwart.</div>
  </div>
</div>

<script>
/* ---------- STATE ---------- */
const storeKey='wisselplanner.v5';
const POS = ['Aanvaller','Middenvelder','Verdediger'];
let state = {
  team:'Team',
  formation:5, // field players (excl. keeper)
  players:[],  // {id,name,pos,present,minutes,benchCd}
  keepersMode:1, // 1,2,4
  keeperByQuarter:[], // [id per quarter 1..4]
  // live
  q:1,
  quarterMs:10*60*1000,
  swapAtMs:5*60*1000,
  running:false,
  tStart:null, // timestamp when quarter started (ms)
  swappedThisQuarter:false,
  schedule:[],
  field:[],bench:[],keeper:null,
};

function uid(){return Math.random().toString(36).slice(2,9)}

/* ---------- PERSIST ---------- */
function save(){localStorage.setItem(storeKey, JSON.stringify(state))}
function load(){
  const raw=localStorage.getItem(storeKey);
  if(raw){state=JSON.parse(raw);}
  else{ initBase(); save(); }
}
function initBase(){
  const names=['Sydney','Wouter','Finn','Dani','Ryan','Milan','Twan','Diede'];
  state.team='De Esch O9';
  state.players = names.map((n,i)=>({id:uid(),name:n,pos:POS[i%3],present:true,minutes:0,benchCd:0}));
  state.formation=5;
  state.keepersMode=1;
  state.keeperByQuarter=[null,null,null,null];
  state.q=1; state.running=false; state.tStart=null; state.swappedThisQuarter=false;
  buildQuarterKeeperDefaults();
  warmStartLineups();
}
function resetAll(){ localStorage.removeItem(storeKey); initBase(); save(); renderAll(); }

/* ---------- HELPERS ---------- */
function presentPlayers(){return state.players.filter(p=>p.present)}
function nameBy(id){const p=state.players.find(x=>x.id===id);return p?p.name:'‚Äî'}
function playerBy(id){return state.players.find(x=>x.id===id)}
function ensureKeeperExclusive(){
  const k=state.keeper;
  if(!k)return;
  state.field=state.field.filter(id=>id!==k);
  state.bench=state.bench.filter(id=>id!==k);
}
function buildQuarterKeeperDefaults(){
  const presents=presentPlayers();
  const first = presents[0]?.id || null;
  if(state.keepersMode===1){
    state.keeperByQuarter=[first,first,first,first];
  }else if(state.keepersMode===2){
    const second = presents[1]?.id || first;
    state.keeperByQuarter=[first,first,second,second];
  }else{
    for(let i=0;i<4;i++){ state.keeperByQuarter[i]=presents[i%presents.length]?.id || first; }
  }
}
function warmStartLineups(){
  // Create starting field/bench for current quarter
  const k = state.keeperByQuarter[state.q-1];
  state.keeper = k;
  const order = state.players.filter(p=>p.present && p.id!==k).map(p=>p.id); // by ranking
  state.field = order.slice(0,state.formation);
  state.bench = order.slice(state.formation);
  preventSamePositionBench();
  ensureKeeperExclusive();
}
function preventSamePositionBench(){
  const posCount={};
  state.bench.forEach(id=>{ const pos=playerBy(id)?.pos; posCount[pos]=(posCount[pos]||0)+1; });
  for(const pos in posCount){
    if(posCount[pos]>1){
      const benchIdx = state.bench.findIndex(id=>playerBy(id)?.pos===pos);
      const fieldIdx = state.field.findIndex(id=>playerBy(id)?.pos!==pos);
      if(benchIdx>-1 && fieldIdx>-1){
        const b=state.bench[benchIdx]; const f=state.field[fieldIdx];
        state.bench[benchIdx]=f; state.field[fieldIdx]=b;
      }
    }
  }
  ensureKeeperExclusive();
}
function twoGapOk(id){ return (playerBy(id)?.benchCd||0)<=0; }
function applyTwoGapDecay(){ state.players.forEach(p=>{ if(p.benchCd>0) p.benchCd--; }); }
function markBenched(ids){ ids.forEach(id=>{ const p=playerBy(id); if(p) p.benchCd=2; }); }

/* ---------- DRAG & DROP (setup order = quality) ---------- */
let dragId=null;
function renderPlayersList(){
  const list=document.getElementById('playerList'); list.innerHTML='';
  state.players.forEach(p=>{
    const el=document.createElement('div'); el.className='player'; el.draggable=true; el.dataset.id=p.id;
    el.innerHTML=`<div class="drag">‚ò∞</div>
      <div class="name" contenteditable="true" spellcheck="false">${p.name}</div>
      <select class="pos">
        ${POS.map(x=>`<option ${x===p.pos?'selected':''}>${x}</option>`).join('')}
      </select>
      <div class="present"><input type="checkbox" ${p.present?'checked':''} title="Aanwezig"></div>
      <div class="del"><button class="btn small danger">üóë</button></div>`;
    el.querySelector('.name').addEventListener('input',e=>{p.name=e.target.textContent.trim(); save();});
    el.querySelector('.pos').addEventListener('change',e=>{p.pos=e.target.value; save();});
    el.querySelector('.present input').addEventListener('change',e=>{p.present=e.target.checked; save();});
    el.querySelector('.del button').addEventListener('click',()=>{
      state.players = state.players.filter(x=>x.id!==p.id); save(); renderPlayersList(); renderQuick(); });
    el.addEventListener('dragstart',()=>{dragId=p.id;});
    el.addEventListener('dragover',e=>{e.preventDefault(); el.style.outline='2px solid var(--accent)';});
    el.addEventListener('dragleave',()=>{el.style.outline='none'});
    el.addEventListener('drop',()=>{
      el.style.outline='none';
      const from = state.players.findIndex(x=>x.id===dragId);
      const to   = state.players.findIndex(x=>x.id===p.id);
      if(from>-1 && to>-1 && from!==to){
        const item=state.players.splice(from,1)[0];
        state.players.splice(to,0,item);
        save(); renderPlayersList();
      }
    });
    list.appendChild(el);
  });
}

function addPlayer(){
  state.players.push({id:uid(),name:'Nieuwe speler',pos:POS[0],present:true,minutes:0,benchCd:0});
  save(); renderPlayersList(); renderQuick();
}

/* ---------- KEEPER ASSIGN UI ---------- */
function keeperAssignRow(containerId, getSelectIdPrefix){
  const row=document.getElementById(containerId); row.innerHTML='';
  const presents=presentPlayers();
  const opts = presents.map(p=>`<option value="${p.id}">${p.name}</option>`).join('');
  if(state.keepersMode===1){
    const selId=`${getSelectIdPrefix}-all`;
    row.innerHTML=`<select id="${selId}">${opts}</select>`;
    document.getElementById(selId).value = state.keeperByQuarter[0]||presents[0]?.id||'';
  }else if(state.keepersMode===2){
    const a=`${getSelectIdPrefix}-h1`, b=`${getSelectIdPrefix}-h2`;
    row.innerHTML=`<div class="grid2" style="width:100%">
      <div><label>1e helft</label><select id="${a}">${opts}</select></div>
      <div><label>2e helft</label><select id="${b}">${opts}</select></div>
    </div>`;
    document.getElementById(a).value=state.keeperByQuarter[0]||presents[0]?.id||'';
    document.getElementById(b).value=state.keeperByQuarter[2]||presents[1]?.id||'';
  }else{
    const ids=[`${getSelectIdPrefix}-q1`,`${getSelectIdPrefix}-q2`,`${getSelectIdPrefix}-q3`,`${getSelectIdPrefix}-q4`];
    row.innerHTML = `<div class="grid2" style="width:100%">
      ${ids.map((id,i)=>`<div><label>Kwart ${i+1}</label><select id="${id}">${opts}</select></div>`).join('')}
    </div>`;
    ids.forEach((id,i)=>{document.getElementById(id).value = state.keeperByQuarter[i]||presents[i%presents.length]?.id||'';});
  }
}

function readKeeperAssignFrom(prefix){
  const presents=presentPlayers();
  function val(id){const s=document.getElementById(id); return s?s.value: (presents[0]?.id||null);}
  if(state.keepersMode===1){
    const k=val(`${prefix}-all`);
    state.keeperByQuarter=[k,k,k,k];
  }else if(state.keepersMode===2){
    const k1=val(`${prefix}-h1`), k2=val(`${prefix}-h2`);
    state.keeperByQuarter=[k1,k1,k2,k2];
  }else{
    state.keeperByQuarter=[val(`${prefix}-q1`),val(`${prefix}-q2`),val(`${prefix}-q3`),val(`${prefix}-q4`)];
  }
}

/* ---------- SCHEDULE ---------- */
function generateScheduleForQuarter(q){
  const k = state.keeperByQuarter[q-1];
  const order = state.players.filter(p=>p.present && p.id!==k).map(p=>p.id); // ranking order
  let field = order.slice(0,state.formation);
  let bench = order.slice(state.formation);
  applyTwoGapDecay();
  preventSamePositionBench();
  const sched=[];
  sched.push({q,slot:1,start:0,end:5,field:[...field],bench:[...bench],keeper:k,out:[],inn:[]});
  // choose one swap
  let out = field.find(id=>twoGapOk(id)) || field[0];
  let inn = bench[0];
  // apply swap
  field = field.map(x=>x===out?inn:x);
  bench = bench.map(x=>x===inn?out:x);
  markBenched([out]);
  sched.push({q,slot:2,start:5,end:10,field:[...field],bench:[...bench],keeper:k,out:[out],inn:[inn]});
  return {sched};
}

function recomputeAll(){
  state.schedule=[];
  for(let q=1;q<=4;q++){
    const {sched} = generateScheduleForQuarter(q);
    state.schedule.push(...sched);
  }
  const first = state.schedule.find(r=>r.q===state.q && r.slot===1);
  state.keeper = first.keeper; state.field=[...first.field]; state.bench=[...first.bench];
  ensureKeeperExclusive();
  save();
}

/* ---------- LIVE TIMER ---------- */
let tickHandle=null;
function msLeftInQuarter(){
  if(!state.running || !state.tStart) return state.quarterMs;
  const elapsed = Date.now()-state.tStart;
  return Math.max(0, state.quarterMs - elapsed);
}
function fmt(ms){ const s=Math.round(ms/1000); const m=Math.floor(s/60); const r=String(s%60).padStart(2,'0'); return `${m}:${r}`; }
function updateLiveUI(){
  document.getElementById('clock').textContent = fmt(msLeftInQuarter());
  document.getElementById('lblQuarter').textContent = `Kwart ${state.q} / 4`;
  document.getElementById('liveKeeper').textContent = nameBy(state.keeper)||'‚Äî';
  document.getElementById('liveField').textContent = state.field.map(nameBy).join(', ')||'‚Äî';
  document.getElementById('liveBench').textContent = state.bench.map(nameBy).join(', ')||'‚Äî';
  const ratio = 1 - (msLeftInQuarter()/state.quarterMs);
  document.getElementById('progressBar').style.width = `${ratio*100}%`;
  const tb=document.querySelector('#scheduleTable tbody'); tb.innerHTML='';
  state.schedule.filter(r=>r.q===state.q).forEach(r=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${r.slot}</td><td>${String(r.start).padStart(2,'0')}-${String(r.end).padStart(2,'0')}m</td>
    <td>${r.field.map(nameBy).join(', ')}</td><td>${r.bench.map(nameBy).join(', ')}</td>`;
    tb.appendChild(tr);
  });
}
function tick(){
  const left = msLeftInQuarter();
  const elapsed = Date.now()-state.tStart;
  if(elapsed>=state.swapAtMs && !state.swappedThisQuarter){
    showSwapOverlayForQuarter(state.q);
    state.swappedThisQuarter=true;
  }
  if(left<=0){
    clearInterval(tickHandle); tickHandle=null; state.running=false;
    alert('Kwart afgelopen');
  }
  updateLiveUI();
}
function startQuarter(){
  state.running=true; state.tStart=Date.now(); state.swappedThisQuarter=false;
  if(tickHandle) clearInterval(tickHandle);
  tickHandle=setInterval(tick,250);
  save();
}
function pause(){ state.running=false; if(tickHandle){clearInterval(tickHandle); tickHandle=null;} save(); }
function nextQuarter(){
  pause();
  if(state.q<4){ state.q++; warmStartLineups(); recomputeAll(); startQuarter(); updateLiveUI(); }
}

/* ---------- SWAP OVERLAY ---------- */
function showSwapOverlayForQuarter(q){
  const row = state.schedule.find(r=>r.q===q && r.slot===2);
  if(!row) return;
  const outN = row.out.map(nameBy); const inN = row.inn.map(nameBy);
  const divOut=document.getElementById('swapOut'); const divIn=document.getElementById('swapIn');
  divOut.innerHTML = outN.map(n=>`<div class="namechip">${n}</div>`).join('') || '<div class="muted">Geen</div>';
  divIn.innerHTML  = inN.map(n=>`<div class="namechip">${n}</div>`).join('') || '<div class="muted">Geen</div>';
  document.getElementById('swapOverlay').style.display='flex';
  if(navigator.vibrate){ navigator.vibrate([200,100,200]); }
}
function hideSwapOverlay(){
  document.getElementById('swapOverlay').style.display='none';
  const row = state.schedule.find(r=>r.q===state.q && r.slot===2);
  if(row){
    state.field=[...row.field]; state.bench=[...row.bench]; ensureKeeperExclusive(); updateLiveUI(); save();
  }
}

/* ---------- QUICK TAB ---------- */
function renderQuick(){
  const cont=document.getElementById('quickActive'); cont.innerHTML='';
  state.players.forEach(p=>{
    const line=document.createElement('div'); line.className='player';
    line.innerHTML=`<div class="name" style="flex:1">${p.name}</div>
      <div class="present"><input type="checkbox" ${p.present?'checked':''}></div>`;
    line.querySelector('input').addEventListener('change',e=>{p.present=e.target.checked; save();});
    cont.appendChild(line);
  });
  const qf=document.getElementById('quickFormation');
  qf.innerHTML=['4','5','6'].map(v=>`<option value="${v}">${v}</option>`).join('');
  qf.value=String(state.formation);
  keeperAssignRow('quickKeeperAssign','quickk');
}

/* ---------- RENDER TABS ---------- */
function renderSetup(){
  document.getElementById('teamName').value=state.team;
  document.getElementById('formation').value=String(state.formation);
  document.getElementById('keepersMode').value=String(state.keepersMode);
  keeperAssignRow('keeperAssignRow','keepk');
  renderPlayersList();
}
function renderLive(){ updateLiveUI(); }
function renderAll(){ renderSetup(); renderLive(); renderQuick(); }

/* ---------- EVENTS ---------- */
document.querySelectorAll('.tab button').forEach(btn=>{
  btn.addEventListener('click',()=>{
    document.querySelectorAll('.tab button').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    document.getElementById('tab-setup').classList.add('hidden');
    document.getElementById('tab-live').classList.add('hidden');
    document.getElementById('tab-quick').classList.add('hidden');
    const id = btn.dataset.tab==='setup'?'tab-setup': (btn.dataset.tab==='live'?'tab-live':'tab-quick');
    document.getElementById(id).classList.remove('hidden');
  });
});
document.getElementById('btnAdd').addEventListener('click',addPlayer);
document.getElementById('btnSaveSetup').addEventListener('click',()=>{
  state.team=document.getElementById('teamName').value.trim()||'Team';
  state.formation=Number(document.getElementById('formation').value)||5;
  state.keepersMode=Number(document.getElementById('keepersMode').value)||1;
  readKeeperAssignFrom('keepk');
  warmStartLineups(); recomputeAll(); save();
  document.querySelector('.tab button[data-tab="live"]').click();
});
document.getElementById('keepersMode').addEventListener('change',()=>{
  state.keepersMode=Number(document.getElementById('keepersMode').value)||1;
  buildQuarterKeeperDefaults(); keeperAssignRow('keeperAssignRow','keepk'); save();
});
document.getElementById('formation').addEventListener('change',()=>{
  state.formation=Number(document.getElementById('formation').value)||5; save();
});
document.getElementById('btnExport').addEventListener('click',()=>{
  const blob=new Blob([JSON.stringify(state,null,2)],{type:'application/json'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='team.json'; a.click();
});
document.getElementById('btnImport').addEventListener('click',()=>{
  const inp=document.createElement('input'); inp.type='file'; inp.accept='application/json';
  inp.onchange=()=>{
    const f=inp.files[0]; if(!f)return;
    const r=new FileReader(); r.onload=()=>{ try{ state=JSON.parse(r.result); save(); renderAll(); }catch(e){alert('Ongeldige JSON');} };
    r.readAsText(f);
  };
  inp.click();
});
document.getElementById('btnReset').addEventListener('click',()=>{ if(confirm('Alles wissen en opnieuw beginnen?')) resetAll(); });
document.getElementById('btnPlay').addEventListener('click',startQuarter);
document.getElementById('btnPause').addEventListener('click',pause);
document.getElementById('btnNext').addEventListener('click',nextQuarter);
document.getElementById('btnDidSwap').addEventListener('click',()=>{ hideSwapOverlay(); });
document.getElementById('btnQuickRecalc').addEventListener('click',()=>{
  state.formation = Number(document.getElementById('quickFormation').value)||state.formation;
  readKeeperAssignFrom('quickk');
  warmStartLineups(); recomputeAll(); save();
});
document.getElementById('btnQuickToLive').addEventListener('click',()=>{
  document.querySelector('.tab button[data-tab="live"]').click();
});

/* ---------- STARTUP ---------- */
load();
buildQuarterKeeperDefaults();
warmStartLineups();
recomputeAll();
renderAll();

if('serviceWorker' in navigator){
  window.addEventListener('load',()=>{ navigator.serviceWorker.register('./sw.js'); });
}
</script>
</body>
</html>
